my_widget_script={mouseNums:[],sampleNums:[],
startTime:"",init:function(mode,json_data){
var parsedJson=this.parseInitJson(json_data)
;if(this.makeVehCard(),this.initDynamicContent(parsedJson),
window.onresize=(()=>this.resize()),
this.addEventListeners(),this.parent_class.init(mode,()=>JSON.stringify(parsedJson.widgetData)),
parsedJson.sampleNums)$("#numSamples").val(parsedJson.sampleNums.length)
;this.addRequiredFieldIndicators(),
this.setUpInitialState(),this.adjustForMode(mode)
},to_json:function(){
var widgetJsonString=this.parent_class.to_json(),dynamicContent=this.getDynamicContent(),output={
widgetData:JSON.parse(widgetJsonString),
mouseNums:dynamicContent.mouseNums,
sampleNums:dynamicContent.sampleNums,
doseNums:dynamicContent.doseNums,
doses:dynamicContent.doses}
;return JSON.stringify(output)},
from_json:function(json_data){
var parsedJson=JSON.parse(json_data)
;this.parent_class.from_json(JSON.stringify(parsedJson.widgetData))
},test_data:function(){
var testData=JSON.parse(this.parent_class.test_data()),output={
widgetData:testData,mouseNums:[2,4],
sampleNums:[1,2,3],doseNums:[1,2],doses:{1:{
id:"10"},2:{id:"3"}}}
;return JSON.stringify(output)},
is_valid:function(b_suppress_message){
var fail=false,fail_log="",name
;if($("#the_form").find("select, textarea, input").each((i,e)=>{
if(!$(e).prop("required"));else if(!$(e).val())fail=true,
name=$(e).attr("id"),fail_log+=name+" is required \n"
}),$("input[type='date']").each((i,e)=>{
var date=$(e).val();if(date){
var validDate=this.isValidDate(date)
;if(!validDate)fail=true,fail_log+="Please enter valid date in form 'YYYY-MM-DD'"
}}),$("input[type='time']").each((i,e)=>{
var time=$(e).val();if(time){
var validtime=this.isValidTime(time)
;if(!validtime)fail=true,fail_log+="Please enter valid time in form 'hh:mm' - 24 hr time"
}}),fail)return alert(fail_log);else{
var noErrors=[];return noErrors}},
is_edited:function(){
return this.parent_class.is_edited()},
reset_edited:function(){
return this.parent_class.reset_edited()},
parseInitJson:function(json_data){var jsonString
;if("string"===typeof json_data)jsonString=json_data;else jsonString=json_data()
;var parsedJson=JSON.parse(jsonString)
;return parsedJson},
initDynamicContent:function(parsedJson){
if(parsedJson.mouseNums)for(var i=0;i<parsedJson.mouseNums.length;i++){
var mouse=parsedJson.mouseNums[i]
;this.makeMouseCard(mouse)}
if(parsedJson.sampleNums)this.makeSampleContent(parsedJson.sampleNums.length)
;if(parsedJson.doses)this.doses=parsedJson.doses;else this.doses={}
;if(parsedJson.doseNums)for(var i=0;i<parsedJson.doseNums.length;i++)dose=parsedJson.doseNums[i],
this.doseNums.push(dose),
this.makeDoseCard(dose);else this.doseNums=[]},
adjustForMode:function(mode){
if("edit"!==mode&&"edit_dev"!==mode)$(".disableOnView").prop("disabled",true),
$(".hideView").hide(),
$("input[type='date']").removeClass(".hasDatePicker"),$(".ifView").show();else if($(".ifView").hide(),
$("input[type='date']").each((i,e)=>{
this.checkDateFormat($(e))
}),$("input[type='time']").each((i,e)=>{
this.checkTimeFormat($(e))
}),$(".table").hide(),$("#expDate").val()&&$("#numSamples").val()>1)$(".samplesDiv").insertBefore(".info")
},addEventListeners:function(){
$(".toggleTable").on("click",e=>{
var tableID=$(e.currentTarget).data("table"),$table=$("#"+tableID),$errorMsg=$(".errorMsg")
;this.toggleTableFuncs($table,$errorMsg)
}),$(".toCSV").on("click",e=>{
var tableID=$(e.currentTarget).data("table"),dateToday=luxon.DateTime.now().toISODate(),fileName="stress_"+tableID+"_"+dateToday,$errorMsg=$(".errorMsg")
;this.toCSVFuncs(fileName,tableID,$errorMsg)
}),$(".copyData").on("click",e=>{
var tableID=$(e.currentTarget).data("table"),tableSearch=this.tableSearch(tableID),$copyHead=$(".copyHead"+tableSearch),$tableToCopy=$("#"+tableID),$tableDiv=$tableToCopy.parent(),$errorMsg=$(".errorMsg"),$divForCopy=$("#forCopy")
;this.copyDataFuncs($copyHead,$tableToCopy,$tableDiv,$errorMsg,$divForCopy)
}),$(".copyOvulation").on("click",e=>{
var tableID=$(e.currentTarget).data("table"),tableSearch=this.tableSearch(tableID),$copyHead=$(".copyHead"+tableSearch),$tableToCopy=$("#"+tableID),$tableDiv=$tableToCopy.parent(),$errorMsg=$(".errorMsg"),$divForCopy=$("#forCopy"),ovulation=true
;this.copyDataFuncs($copyHead,$tableToCopy,$tableDiv,$errorMsg,$divForCopy,ovulation=ovulation)
}),$(".copyLH").on("click",e=>{
var $errorMsg=$(".errorMsg"),$divForCopy=$("#forCopy")
;this.copyLHSampleNums($divForCopy,$errorMsg)
}),$(".copyNutella").on("click",e=>{
var $errorMsg=$(".errorMsg"),$divForCopy=$("#forCopy")
;this.copyNutellaEating($divForCopy,$errorMsg)})},
isValidTime:function(timeString){
var regEx="^(((([0-1][0-9])|(2[0-3])):[0-5][0-9]))$"
;if(!timeString.match(regEx))return false;else return true
},isTimeSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","time"),input.setAttribute("name","testTime")
;var supported=true
;if("time"!==input.type)supported=false
;return this.timeSupported=supported,input.remove(),
supported},timeSupported:true,
checkTimeFormat:function($timeInput){
if(!this.timeSupported){
$timeInput.next(".timeWarning").remove()
;var time=$timeInput.val(),isValid=this.isValidTime(time)
;if(!isValid)$timeInput.after('<div class="text-danger timeWarning">Enter time as "hh:mm" in 24-hr format</div>')
;this.resize()}},isValidDate:function(dateString){
var regEx=/^\d{4}-\d{2}-\d{2}$/
;if(!dateString.match(regEx))return false
;var d=new Date(dateString),dNum=d.getTime()
;if(!dNum&&0!==dNum)return false
;return d.toISOString().slice(0,10)===dateString},
isDateSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","date"),input.setAttribute("name","testdate")
;var supported=true
;if("date"!==input.type)supported=false
;return this.dateSupported=supported,input.remove(),
supported},dateSupported:true,
checkDateFormat:function($dateInput){
if(!this.dateSupported){
$dateInput.next(".dateWarning").remove()
;var date=$dateInput.val(),isValid=this.isValidDate(date)
;if(!isValid)$dateInput.after('<div class="text-danger dateWarning">Enter date as "YYYY-MM-DD"</div>')
;$dateInput.datepicker({dateFormat:"yy-mm-dd"
}),this.resize()}},
addRequiredFieldIndicators:function(){
$(".needForTableLab").each((i,e)=>{
$(e).html("<span style='color:blue'>#</span>"+$(e).html())
}),$(".requiredLab").each((i,e)=>{
$(e).html("<span style='color:red'>*</span>"+$(e).html())
})},updateTextareas:function(){
$("textarea.autoAdjust").each((i,e)=>{
if(!$(e).is(":hidden"))e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")
}),this.resize()},
updateTextarea:function(textarea){
if(!$(textarea).is(":hidden"))textarea.setAttribute("style","height:"+textarea.scrollHeight+"px;overflow-y:hidden;")
;this.resize()},setUpInitialState:function(){
for(var sampleNum of(this.isDateSupported(),
this.isTimeSupported(),$("input[type='date']").prop("placeholder","YYYY-MM-DD").on("change",e=>{
this.checkDateFormat($(e.currentTarget))
}),$("input[type='time']").prop("placeholder","hh:mm").on("change",e=>{
this.checkTimeFormat($(e.currentTarget))
}),$(".myLeftCol").addClass("col-12 col-sm-6 col-md-4 col-lg-3 text-left text-sm-right"),
$("textarea.autoAdjust").each((i,e)=>{
var height=e.scrollHeight;if(0==height){
text=$(e).val(),$(".forTextBox").show(),
$("#forSizing").val(text)
;var forSizing=document.getElementById("forSizing")
;height=forSizing.scrollHeight,
$(".forTextBox").hide()}
e.setAttribute("style","height:"+height+"px;overflow-y:hidden;")
}).on("input",e=>{
e.currentTarget.style.height="auto",e.currentTarget.style.height=e.currentTarget.scrollHeight+"px",
this.resize()}),$("#numSamples").on("input",e=>{
var totalNumSamples=$(e.currentTarget).val()
;if(totalNumSamples)totalNumSamples=parseInt(totalNumSamples);else totalNumSamples=0
;this.makeSampleContent(totalNumSamples)
}),$(".otherSample").each((i,e)=>{
this.showIfOtherCheck($(e))}).on("change",e=>{
this.showIfOtherCheck($(e.currentTarget))
}),$("#timeZone").each((i,e)=>{
if("est"==$(e).val())startHour=9;else startHour=10
;this.startTime=luxon.DateTime.fromObject({
hour:startHour,minute:30
}),this.printExpTimes(),this.watchSampleLabel()
}).on("change",e=>{
if("est"==$(e.currentTarget).val())startHour=9;else startHour=10
;this.startTime=luxon.DateTime.fromObject({
hour:startHour,minute:30
}),this.printExpTimes(),this.watchSampleLabel()
}),$("#addMouse").on("click",e=>{
if(this.mouseNums.length>0)var lastMouse=this.mouseNums[this.mouseNums.length-1],mouseNum=lastMouse+1;else var mouseNum=1
;this.makeMouseCard(mouseNum)
;var totalNumSamples=$("#numSamples").val()
;if(totalNumSamples)totalNumSamples=parseInt(totalNumSamples);else totalNumSamples=0
;this.makeSampleContent(totalNumSamples)
}),this.mouseNums.forEach(mouseNum=>{
this.watchMouseID(mouseNum),this.changeViewForSex(mouseNum)
;var mouseSearch=this.mouseSearch(mouseNum)
;$(".checkSacrifice"+mouseSearch).each((i,e)=>{
if($(e).is(":checked"))$(".ifSacrifice"+mouseSearch).show();else $(".ifSacrifice"+mouseSearch).hide()
}),$(".checkOvulation"+mouseSearch).each((i,e)=>{
if($(e).is(":checked"))$(".ifOvulation"+mouseSearch).show();else $(".ifOvulation"+mouseSearch).hide()
})
}),$.each(my_widget_script.sampleNums,function(){
my_widget_script.watchSampleLabel(this)
}),$(".treatment").each((i,e)=>{
if("control"==$(e).val())$(e).val("CON");else if("stress"==$(e).val())$(e).val("ALPS")
}),$(".watch").each((i,e)=>{this.watchValue($(e))
}),$(".calcNutella").on("change",e=>{
var mouseNum=$(e.currentTarget).data("mouse")
;this.calcNutella(mouseNum)
}),$(".calcAllNutella").on("change",e=>{
this.calcAllNutella()
}),this.calcAllNutella(),$("#drugName").each((i,e)=>{
this.showOther($(e))}).on("input",e=>{
this.showOther($(e.currentTarget)),this.changeStockConc($(e.currentTarget))
}),$("#addDose").on("click",e=>{
if(this.doseNums.length>0)var lastDose=this.doseNums[this.doseNums.length-1],doseNum=lastDose+1;else var doseNum=1
;var inArray=this.checkInArray(doseNum,this.doseNums)
;if(!inArray)this.doseNums.push(doseNum),
this.doses[doseNum]={},this.makeDoseCard(doseNum)
}),$("#stockConc").on("change",e=>{
this.calcAllStock()}),$(".sex").each((i,e)=>{
var sex=$(e).val(),mouseNum=$(e).data("mouse"),mouseSearch=this.mouseSearch(mouseNum)
;if("female"==sex){
if($(".ifFemale"+mouseSearch).show(),$(".checkOvulation"+mouseSearch).is(":checked"))$(".ifOvulation"+mouseSearch).show()
}else $(".ifFemale"+mouseSearch).hide().find(".stage").val(""),
$(".ifFemale"+mouseSearch).find(".checkOvulation").prop("checked",false),
$(".ifOvulation"+mouseSearch).hide()
}),$(".nutellaAtTime").each((i,e)=>{
var sampleNum=$(e).data("sample"),sampleSearch=this.sampleSearch(sampleNum)
;if($(e).is(":checked"))$(".ifNutella"+sampleSearch).show();else $(".ifNutella"+sampleSearch).hide()
}),$(".LH").each((i,e)=>{
var sampleNum=$(e).data("sample"),sampleSearch=this.sampleSearch(sampleNum)
;if($(e).is(":checked"))$(".ifLH"+sampleSearch).show();else $(".ifLH"+sampleSearch).hide()
}),
this.sampleNums))this.adjustForSampling(sampleNum)
;this.calcAllStock(),this.calcVehicle(),
this.resize()},
adjustForSampling:function(sampleNum){
var sampleSearch=this.sampleSearch(sampleNum)
;if($(".cort"+sampleSearch).is(":checked")||$(".LH"+sampleSearch).is(":checked")||$(".otherSample"+sampleSearch).is(":checked"))$(".ifSampling"+sampleSearch).show();else $(".ifSampling"+sampleSearch).hide()
;this.resize()},makeVehCard:function(){
var $div=$("#vehCards");$div.html("")
;var row="row mt-2",col="col-12 col-lg-6"
;$div.append($("<div></div>",{
class:"col col-md-6 mt-2 vehCard"
}).append($("<div></div>",{class:"card"
}).append($("<button></button>",{
class:"card-header vehHeader",type:"button"
}).on("click",e=>{
this.toggleCard($(e.currentTarget))
}).append("Vehicle")).append($("<div></div>",{
class:"card-body collapse"
}).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("<h4>Volume (&micro;L/Nutella dose):</h4>")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"number",id:"vehVol",name:"vehvol",
class:"vehVol fullWidth watch vehCalc",
"data-watch":"veh"})))).append($("<div></div>",{
class:row}).append($("<div></div>",{class:col
}).append("Amount Nutella/mouse:")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"number",val:60,id:"nutellaPerMouseVeh",
name:"nutellapermouseveh",
class:"nutellaPerMouseVeh fullWidth watch vehCalc",
"data-watch":"nutellaPerMouseVeh"
})))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("Measured Nutella (mg):")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"number",id:"amntNutellaVeh",
name:"amntnutellaveh",
class:"amntNutellaVeh fullWidth watch vehCalc",
"data-watch":"amntNutellaVeh"
})))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("# of Nutella doses:")).append($("<div></div>",{
class:"col numMiceDosesVeh"
}))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("Vehicle to add:")).append($("<div></div>",{
class:"col calcedVehicle"
})))))),$(".watch").on("input",e=>{
this.watchValue($(e.currentTarget))
}),$(".vehCalc").on("change",e=>{
this.calcVehicle()}),this.resize()},
getCurrentDoseChoices:function(){
for(var mice=this.mouseNums,currentSels={},i=0;i<mice.length;i++){
var mouse=mice[i],mouseSearch=this.mouseSearch(mouse),mouseSel=$(".mouseDose"+mouseSearch).val()
;currentSels[mouse]={},
currentSels[mouse].search=mouseSearch,currentSels[mouse].sel=mouseSel
}return currentSels},updateDoseChoices:function(){
var mice=this.mouseNums,currentSels=this.getCurrentDoseChoices(),$doseSelects=$(".mouseDose")
;$doseSelects.html(""),
$doseSelects.append($("<option></option>",{value:0
}).append("Vehicle"));var doses=this.doses
;for(var doseNum in doses){
var dosage=doses[doseNum].id
;if(!dosage>0)dosage=doseNum,doseText="Dose #"+doseNum;else doseText=dosage+"mg/kg"
;$doseSelects.append($("<option></option>",{
value:dosage}).append(doseText))}
for(var i=0;i<mice.length;i++){
var mouse=mice[i],mouseSearch=currentSels[mouse].search,prevSel=currentSels[mouse].sel
;$(".mouseDose"+mouseSearch).val(prevSel)}},
deleteDoseFuncs:function(el){
var doseNum=$(el).data("dose")
;this.runIfConfirmed("Are you sure that you wish to delete this dose?",()=>{
var index=this.doseNums.indexOf(doseNum)
;if(index>-1)this.doseNums.splice(index,1)
;delete this.doses[doseNum]
;var doseSearch=this.doseSearch(doseNum)
;$(doseSearch).remove(),this.updateDoseChoices()
},el),this.resize()},
makeDoseCard:function(doseNum){
this.updateDoseChoices();var $div=$("#doseCards")
;if(!$div.find(".card").length)$div.html("")
;var row="row mt-2",col="col-12 col-lg-6"
;$div.append($("<div></div>",{
class:"col col-md-6 mt-2 doseCard",
"data-dose":doseNum}).append($("<div></div>",{
class:"card"}).append($("<button></button>",{
class:"card-header doseHeader",type:"button",
"data-calc":"dose","data-dose":doseNum
}).on("click",e=>{
this.toggleCard($(e.currentTarget))
}).append("Dose "+doseNum)).append($("<div></div>",{
class:"card-body collapse"
}).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("<h4>Dosage (mg/kg):</h4>")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"number","data-dose":doseNum,
id:"dosage"+doseNum,name:"dosage"+doseNum,
class:"dosage fullWidth watch stockCalc",
"data-watch":"dose"}).on("change",e=>{
this.doses[doseNum]["id"]=$(e.currentTarget).val(),
this.updateDoseChoices()
})))).append($("<div></div>",{
class:row+" hideView"}).append($("<div></div>",{
class:col
}).append("Delete:")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"button",value:"Delete Dose",
"data-dose":doseNum,id:"deleteDose"+doseNum,
name:"deletedose"+doseNum,
class:"deleteDose fullWidth"}).on("click",e=>{
this.deleteDoseFuncs(e.currentTarget)
})))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("Avg mouse mass (g):")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"number",val:25,"data-dose":doseNum,
id:"avgMouseMass"+doseNum,
name:"avgmousemass"+doseNum,
class:"avgMouseMass fullWidth watch stockCalc",
"data-watch":"avgMouseMass"
})))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("Amount Nutella/mouse:")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"number",val:60,"data-dose":doseNum,
id:"nutellaPerMouse"+doseNum,
name:"nutellapermouse"+doseNum,
class:"nutellaPerMouse fullWidth watch stockCalc",
"data-watch":"nutellaPerMouse"
})))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("Measured Nutella (mg):")).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"number","data-dose":doseNum,
id:"amntNutella"+doseNum,
name:"amntnutella"+doseNum,
class:"amntNutella fullWidth watch stockCalc",
"data-watch":"amntNutella"
})))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("Stock per mouse:")).append($("<div></div>",{
class:"col stockPerMouse","data-dose":doseNum
}))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("# of Nutella doses:")).append($("<div></div>",{
class:"col numMiceDoses","data-dose":doseNum
}))).append($("<div></div>",{class:row
}).append($("<div></div>",{class:col
}).append("Stock to add:")).append($("<div></div>",{
class:"col calcedStock","data-dose":doseNum
})))))),$(".watch").on("input",e=>{
this.watchValue($(e.currentTarget))
}),$(".stockCalc").on("change",e=>{
this.calcStock($(e.currentTarget).data("dose"))
}),this.resize()},toggleCard:function($cardHead){
$cardHead.next().toggleClass("collapse"),
$cardHead.next().find("textarea.autoAdjust").each((i,e)=>{
if(!$(e).is(":hidden"))e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")
}),this.resize()},
addToStartTime:function(hoursToAdd){
var newTime=this.startTime.plus({hours:hoursToAdd
}),newTimeString=newTime.toLocaleString(luxon.DateTime.TIME_24_SIMPLE)
;return newTimeString},printExpTimes:function(){
$(".expStartTime").text(this.addToStartTime(0)),
$(".expRestraintTime").text(this.addToStartTime(1)),
$(".expScentTime").text(this.addToStartTime(3)),
$(".expEndTime").text(this.addToStartTime(5))},
calcAllStock:function(){
if(this.doseNums.length>0)for(doseNum in this.doses)this.calcStock(doseNum)
},doseNums:[],doses:{},stockConcs:{cort:25},
changeStockConc:function($drugNameEl){
var drug=$drugNameEl.val(),conc=this.stockConcs[drug]
;if(conc)$("#stockConc").val(conc);else $("#stockConc").val("")
},calcStock:function(doseNum){
var doseSearch=this.doseSearch(doseNum),stockConc=$("#stockConc").val(),stockAmnt,stockAmntPerMouse,nutellaForMouse
;if(stockConc>0){
var dosage=$(".dosage"+doseSearch).val()
;if(dosage>0){
var avgMouse=$(".avgMouseMass"+doseSearch).val()
;if(avgMouse>0){
var nutellaPerMouse=$(".nutellaPerMouse"+doseSearch).val()
;if(nutellaPerMouse>0){
var mouseMass=$(".mouseMass"+doseSearch).val()
;if(mouseMass>0)nutellaForMouse=mouseMass/avgMouse*nutellaPerMouse
;var amntNutella=$(".amntNutella"+doseSearch).val()
;if(amntNutella>0)stockAmntPerMouse=avgMouse*(1/1e3)*dosage*(1/stockConc)*1e3,
numMiceDoses=amntNutella/nutellaPerMouse,
stockAmnt=numMiceDoses*stockAmntPerMouse;else stockAmnt="{Enter measured Nutella}"
}else stockAmnt="{Enter Nutella/mouse}"
}else stockAmnt="{Enter avg mouse mass}"
}else stockAmnt="{Enter dosage}"
}else stockAmnt="{Enter stock conc}"
;if(isNaN(stockAmnt))stockAmntPerMouse=stockAmnt,
numMiceDoses=stockAmnt,nutellaForMouse=stockAmnt;else{
if(stockAmnt>0)stockAmnt=+stockAmnt.toFixed(2)+"&micro;L";else stockAmnt="{double check entries}"
;if(stockAmntPerMouse>0)stockAmntPerMouse=+stockAmntPerMouse.toFixed(2)+"&micro;L";else stockAmntPerMouse="{double check entries}"
;if(numMiceDoses>0)numMiceDoses=+numMiceDoses.toFixed(2);else numMiceDoses="{double check entries}"
;if(nutellaForMouse>0)nutellaForMouse=+nutellaForMouse.toFixed(2)+"mg";else nutellaForMouse="{double check entries}"
}
$(".stockPerMouse"+doseSearch).html(stockAmntPerMouse),$(".numMiceDoses"+doseSearch).html(numMiceDoses),
$(".calcedStock"+doseSearch).html(stockAmnt),
$(".adjNutellaForMouse"+doseSearch).html(nutellaForMouse)
},calcVehicle:function(){
var vehAmnt,vehVol=$(".vehVol").val()
;if(vehVol>0){
var nutellaPerMouse=$(".nutellaPerMouseVeh").val()
;if(nutellaPerMouse>0){
var amntNutella=$(".amntNutellaVeh").val()
;if(amntNutella>0)numMiceDoses=amntNutella/nutellaPerMouse,
vehAmnt=numMiceDoses*vehVol;else vehAmnt="{Enter measured Nutella}"
}else vehAmnt="{Enter Nutella/mouse}"
}else vehAmnt="{Enter dosage}"
;if(isNaN(vehAmnt))numMiceDoses=vehAmnt;else{
if(vehAmnt>0)vehAmnt=+vehAmnt.toFixed(2)+"&micro;L";else vehAmnt="{double check entries}"
;if(numMiceDoses>0)numMiceDoses=+numMiceDoses.toFixed(2);else numMiceDoses="{double check entries}"
}
$(".numMiceDosesVeh").html(numMiceDoses),$(".calcedVehicle").html(vehAmnt)
},showOther:function($el){if("other"===$el.val()){
var $other=$el.next(".ifOther").show(),thisScrollHeight=$other.prop("scrollHeight")
;$other.css("height",thisScrollHeight).css("overflow-y","hidden")
}else $el.next(".ifOther").hide();this.resize()},
resize:function(){
this.parent_class.resize_container()},
getDynamicContent:function(){var dynamicContent={
mouseNums:this.mouseNums,
sampleNums:this.sampleNums,doseNums:this.doseNums,
doses:this.doses};return dynamicContent},
data_valid_form:function(){var valid=true
;if($(".needForTable").each((i,e)=>{
if(!$(e).val())valid=false
}),!valid)$(".errorMsg").html("<span style='color:red; font-size:36px;'>Please fill out all elements marked by a</span><span style='color:blue; font-size:36px;'> blue #</span>");else $(".errorMsg").html("")
;return valid},
checkInArray:function(searchVal,array){
var proceed=-1!==$.inArray(searchVal,array)
;return proceed},watchMouseID:function(mouseNum){
var mouseSearch=this.mouseSearch(mouseNum),mouseID=$(".mouseID"+mouseSearch).val(),shortID=$(".shortID"+mouseSearch).val()
;if(!mouseID)mouseID="[Enter Mouse "+mouseNum+" ID]"
;if($(".mouseIDCalc"+mouseSearch).html(mouseID),
mouseID==shortID||!shortID)shortID="";else shortID=" - "+shortID
;$(".shortIDCalc"+mouseSearch).html(shortID)},
watchSampleLabel:function(sampleNum){
var sampleSearch=this.sampleSearch(sampleNum),sampleID=$(".sampleLabel"+sampleSearch).val(),sampleTime=$(".sampleTime"+sampleSearch).val()
;if(!sampleID)sampleID="Sample "+sampleNum
;if(sampleTime)sampleTime="Hr "+sampleTime+" - "+this.addToStartTime(parseFloat(sampleTime)),
sampleID=sampleTime+" - "+sampleID
;$(".sampleLabelCalc"+sampleSearch).html(sampleID)
},watchValue:function($el){
var watch=$el.data("watch"),calcSearch=this.calcSearch(watch),sampleNum=$el.data("sample"),mouseNum=$el.data("mouse"),doseNum=$el.data("dose"),val=$el.val()
;if(doseNum)calcSearch+=this.doseSearch(doseNum)
;if(sampleNum)calcSearch+=this.sampleSearch(sampleNum)
;if(mouseNum)calcSearch+=this.mouseSearch(mouseNum)
;if("on"==val)if("checkbox"==$el.prop("type"))if($el.is(":checked"))val="Yes";else val="No"
;if("dose"==watch)if(!val||isNaN(val))val="Dose "+doseNum;else val+=" mg/kg"
;$(calcSearch).html(val)},
makeRow:function(label,$input,addRowClass=""){
var myLeftCol="col-12 col-lg-6"
;if(addRowClass)addRowClass=" "+addRowClass
;var $label=$("<label></label>",{
for:$input.attr("id")
}).append(label),$row=$("<div></div>",{
class:"row mt-2"+addRowClass
}).append($("<div></div>",{class:myLeftCol
}).append($label)).append($("<div></div>",{
class:"col"}).append($input));return $row},
makeInput:function(inputType,className,mouseNum,optionsObj){
var lowerCaseName=className.toLowerCase()
;if("select"===inputType)for(option of($input=$("<select></select>",{
name:lowerCaseName+mouseNum,id:className+mouseNum,
class:className+" fullWidth watch",
"data-watch":className,"data-mouse":mouseNum
}),optionsObj))$input.append($("<option></option>",{
value:option.value
}).append(option.text));else if("textarea"===inputType)$input=$("<tex"+"tarea></tex"+"tarea>",{
name:lowerCaseName+mouseNum,id:className+mouseNum,
class:className+" fullWidth watch autoAdjust",
"data-watch":className,"data-mouse":mouseNum
}).on("input",e=>{
this.updateTextarea(e.currentTarget)
});else var $input=$("<input></input>",{
type:inputType,name:lowerCaseName+mouseNum,
id:className+mouseNum,
class:className+" fullWidth watch",
"data-watch":className,"data-mouse":mouseNum})
;if("time"===inputType)$input.each((i,e)=>{
this.checkTimeFormat($(e))}).on("change",e=>{
this.checkTimeFormat($(e.currentTarget))})
;if("date"===inputType)$input.each((i,e)=>{
this.checkDateFormat($(e))}).on("change",e=>{
this.checkDateFormat($(e.currentTarget))})
;return $input},
changeViewForSex:function(mouseNum){
var mouseSearch=this.mouseSearch(mouseNum),sex=$(".sex"+mouseSearch).val()
;if("female"==sex){
if($(".ifFemale"+mouseSearch).show(),$(".checkOvulation"+mouseSearch).is(":checked"))$(".ifOvulation"+mouseSearch).show()
}else $(".ifFemale"+mouseSearch).hide().find(".stage").val(""),
$(".ifFemale"+mouseSearch).find(".checkOvulation").prop("checked",false),
$(".ifOvulation"+mouseSearch).hide()},
makeRowFromObj:function(obj,mouseNum){
var $row=this.makeRow(obj.label,this.makeInput(obj.type,obj.className,mouseNum,obj.optionsObj),obj.addRowClass)
;return $row},makeMouseCard:function(mouseNum){
var inArray=this.checkInArray(mouseNum,this.mouseNums)
;if(!inArray){this.mouseNums.push(mouseNum)
;var $div=$(".mouseInfo")
;if(!$div.find(".card").length)$div.html("")
;var row="row mt-2",col="col-12 col-lg-6"
;$div.append($("<div/>",{
class:"col col-md-6 mt-2 mouseCard",
"data-mouse":mouseNum}).append($("<div/>",{
class:"card"}).append($("<button></button>",{
type:"button",class:"card-header mouseIDCalc",
"data-mouse":mouseNum}).on("click",e=>{
this.toggleCard($(e.currentTarget))
}).append("[Enter Mouse ID]")).append($("<div/>",{
class:"card-body collapse"}))))
;var $body=$div.find(".card-body").last(),initialRows=[{
label:"<h4>Mouse ID:</h4>",type:"text",
className:"mouseID"},{
label:"Short ID (for labels):",type:"text",
className:"shortID"},{label:"Stress Treatment:",
type:"select",className:"treatment",optionsObj:[{
value:"CON",text:"Control"},{value:"ALPS",
text:"Stress"}]},{label:"Drug Treatment",
type:"select",className:"mouseDose",optionsObj:[]
},{label:"Delete:",type:"button",
className:"deleteMouse",optionsObj:[],
addRowClass:" hideView"},{label:"Sex:",
type:"select",className:"sex",optionsObj:[{
value:"",text:"[Select]"},{value:"male",
text:"Male"},{value:"female",text:"Female"}]}]
;for(row of initialRows)$body.append(this.makeRowFromObj(row,mouseNum))
;$body.find(".mouseID").on("input",e=>{
this.watchMouseID(mouseNum)
}),$body.find(".shortID").on("input",e=>{
this.watchMouseID(mouseNum)
}),$body.find(".deleteMouse").on("click",e=>{
this.deleteMouseFuncs(mouseNum)
}),$body.find(".sex").on("click",e=>{
this.changeViewForSex(mouseNum)}).each((i,e)=>{
this.changeViewForSex(mouseNum)
}),$body.find(".deleteMouse").prop("value","Delete Mouse"),
$body.append($("<div></div>",{class:"ifFemale",
"data-mouse":mouseNum
}).append(this.makeRowFromObj({
label:"Estrous Stage:",type:"select",
className:"stage",optionsObj:[{value:"",
text:"Select"},{value:"diestrus",text:"Diestrus"
},{value:"proestrus",text:"Proestrus"},{
value:"estrus",text:"Estrus"}]},mouseNum)))
;var secondSetRows=[{label:"Start Body Mass (g):",
type:"number",className:"mass"},{
label:"Post Body Mass (g):",type:"number",
className:"postBodyMass"},{
label:"Was mouse sacrificed?",type:"checkbox",
className:"checkSacrifice"}]
;for(row of secondSetRows)$body.append(this.makeRowFromObj(row,mouseNum))
;$body.find(".mass").on("input",e=>{
this.calcNutella(mouseNum)
}).closest(".row").after(this.makeRow("Nutella for mouse",$("<div></div>",{
class:"adjNutellaForMouse","data-mouse":mouseNum
}))),$body.find(".checkSacrifice").on("change",e=>{
var mouseSearch=this.mouseSearch(mouseNum)
;if($(e.currentTarget).is(":checked"))$(".ifSacrifice"+mouseSearch).show();else $(".ifSacrifice"+mouseSearch).hide()
;this.resize()}),$body.append($("<div></div>",{
class:"ifSacrifice","data-mouse":mouseNum}))
;var $ifSacrifice=$body.find(".ifSacrifice"),sacRows=[{
label:"Sac date:",type:"date",className:"sacDate"
},{label:"Sac time:",type:"time",
className:"sacTime"},{
label:"Uterine/Seminal Vesicle Mass (mg):",
type:"number",className:"reproMass"},{
label:"Uterine/Seminal Vesicle Description",
type:"textarea",className:"reproDescription"},{
label:"Ovarian/Testicular Mass (mg):",
type:"number",className:"gonadMass"},{
label:"Adrenal Mass (mg):",type:"number",
className:"adrenalMass"}]
;for(row of sacRows)$ifSacrifice.append(this.makeRowFromObj(row,mouseNum))
;$ifSacrifice.append($("<div></div>",{
class:"ifFemale","data-mouse":mouseNum
}).append(this.makeRowFromObj({
label:"Check for ovulation?",type:"checkbox",
className:"checkOvulation"
},mouseNum)).append($("<div></div>",{
class:"ifOvulation","data-mouse":mouseNum
}))),$ifSacrifice.find(".checkOvulation").on("change",e=>{
var mouseSearch=this.mouseSearch(mouseNum)
;if($(e.currentTarget).is(":checked"))$(".ifOvulation"+mouseSearch).show();else $(".ifOvulation"+mouseSearch).hide()
;this.resize()})
;var $ifOvulation=$ifSacrifice.find(".ifOvulation"),ifOvulationRows=[{
label:"Estrous Stage:",type:"text",
className:"nextStage"},{
label:"# Oocytes - oviduct 1:",type:"number",
className:"oocytes1"},{
label:"# Oocytes - oviduct 2:",type:"number",
className:"oocytes2"}]
;for(row of ifOvulationRows)$ifOvulation.append(this.makeRowFromObj(row,mouseNum))
;$body.append(this.makeRowFromObj({label:"Notes:",
type:"textarea",className:"notes"},mouseNum))
;var $mouseTable=$("#mouseTable")
;$mouseTable.find("tbody").append($("<tr/>",{
"data-mouse":mouseNum}))
;var $mouseTable2=$("#mouseTable2")
;$mouseTable2.find("tbody").append($("<tr/>",{
"data-mouse":mouseNum}))
;var $mouseTable3=$("#mouseTable3")
;$mouseTable3.find("tbody").append($("<tr/>",{
"data-mouse":mouseNum}))
;for(var calcs=["mouseID","sex","stage","treatment","mouseDose","mass","reproMass","gonadMass","adrenalMass","postBodyMass"],calcs2=["mouseID","date","stage","treatment","mouseDose","mass","reproMass","gonadMass","adrenalMass","postBodyMass"],calcs3=["mouseID","date","stage","treatment","mouseDose","mass","reproMass","gonadMass","adrenalMass","postBodyMass","sacDate","sacTime","nextStage","reproDescription","oocytes1","oocytes2","notes"],mouseSearch=this.mouseSearch(mouseNum),i=0;i<calcs.length;i++){
var calc=calcs[i]
;$mouseTable.find("tbody").find("tr"+mouseSearch).append($("<td></td>",{
"data-calc":calc,"data-mouse":mouseNum}))}
for(var i=0;i<calcs2.length;i++){
var calc=calcs2[i]
;if("date"!==calc)$mouseTable2.find("tbody").find("tr"+mouseSearch).append($("<td></td>",{
"data-calc":calc,"data-mouse":mouseNum
}));else $mouseTable2.find("tbody").find("tr"+mouseSearch).append($("<td></td>",{
"data-calc":calc}))}
for(var i=0;i<calcs3.length;i++){
var calc=calcs3[i]
;$mouseTable3.find("tbody").find("tr"+mouseSearch).append($("<td></td>",{
"data-calc":calc,"data-mouse":mouseNum}))}
this.calcNutella(mouseNum),this.updateDoseChoices(),
this.updateTextareas(),this.resize()}},
deleteMouseFuncs:function(mouseNum){
var proceed=confirm("Are you sure that you wish to delete this mouse?")
;if(proceed){
var index=this.mouseNums.indexOf(mouseNum)
;if(index>-1)this.mouseNums.splice(index,1)
;if(this.sampleNums)for(var numSamples=this.sampleNums.length,i=0;i<numSamples;i++){
var sample=this.sampleNums[i],index=this.miceInSamples[sample].indexOf(mouseNum)
;if(index>-1)this.miceInSamples[sample].splice(index,1)
}var mouseSearch=this.mouseSearch(mouseNum)
;$(".mouseCard"+mouseSearch).remove(),
$(".mouseSampleCard"+mouseSearch).remove(),
$("tr"+mouseSearch).remove()}this.resize()},
calcAllNutella:function(){var mice=this.mouseNums
;if(mice)var numMice=mice.length;else var numMice=0
;for(var i=0;i<numMice;i++){var mouseNum=mice[i]
;this.calcNutella(mouseNum)}},
calcNutella:function(mouseNum){
var mouseSearch=this.mouseSearch(mouseNum),nutellaPerAvgMouse=$("#nutellaPerMouse").val(),avgMouse=$("#avgMouseMass").val()
;if(nutellaPerAvgMouse>0)if(avgMouse>0){
var mouseMass=$(".mass"+mouseSearch).val()
;if(mouseMass>0)nutellaForMouse=mouseMass/avgMouse*nutellaPerAvgMouse;else nutellaForMouse="{Enter mouse mass}"
}else nutellaForMouse="{Enter avg mouse mass}";else nutellaForMouse="{Enter Nutella/mouse}"
;if(!isNaN(nutellaForMouse))if(nutellaForMouse>0)nutellaForMouse=+nutellaForMouse.toFixed(2)+"mg";else nutellaForMouse="{double check entries}"
;$(".adjNutellaForMouse"+mouseSearch).html(nutellaForMouse)
},makeSampleContent:function(totalNumSamples){
var sampleNum,mice=this.mouseNums
;if(mice)var numMice=mice.length;else var numMice=0
;for(var i=0;i<totalNumSamples;i++){
if(sampleNum=i+1,!this.checkInArray(sampleNum,this.sampleNums)){
if(1==sampleNum)$("#samplesAccordion").html(""),
$(".sampleInfoDiv").html("")
;this.sampleNums.push(sampleNum),this.miceInSamples[sampleNum]=[],
this.makeSampleInfo(sampleNum),
this.makeSamplingCard(sampleNum),this.makeSampleForTables(sampleNum)
}for(var j=0;j<numMice;j++){
var mouse=mice[j],inSample=this.checkMiceInSamples(sampleNum,mouse)
;if(!inSample)this.miceInSamples[sampleNum].push(mouse),
this.makeSampleForMouse(sampleNum,mouse)
;this.watchMouseID(mouse)}}
if(this.sampleNums)for(var proceed=true,i=this.sampleNums.length;i>-1;i--)if(proceed){
var sampleNum=this.sampleNums[i]
;if(sampleNum>totalNumSamples)if(proceed=confirm("Are sure that you want to remove a sampling time?"),
proceed)$(this.sampleSearch(sampleNum)).remove(),
this.sampleNums.splice(i,1);else $("#numSamples").val(this.sampleNums.length)
}$(".watch").each((i,e)=>{this.watchValue($(e))
}).on("input",e=>{
this.watchValue($(e.currentTarget))
}),this.resize()},miceInSamples:{},
makeSampleForTables:function(sampleNum){
var $sample=$("#sampleTable"),calcs=["sampleLabel","sampleTime","cort","LH","otherName"]
;$sample.find("tbody").append($("<tr/>",{
"data-sample":sampleNum}))
;for(var sampleSearch=this.sampleSearch(sampleNum),i=0;i<calcs.length;i++){
var calc=calcs[i]
;$sample.find("tr"+sampleSearch).append($("<td/>",{
"data-calc":calc,"data-sample":sampleNum}))}
var $mouse=$("#mouseTable")
;$mouse.find("thead").find("tr").append($("<th/>",{
"data-sample":sampleNum
}).append("Sample"+sampleNum+"Start")).append($("<th/>",{
"data-sample":sampleNum
}).append("Sample"+sampleNum+"End")).append($("<th/>",{
"data-sample":sampleNum
}).append("Nutella"+sampleNum+"Start")).append($("<th/>",{
"data-sample":sampleNum
}).append("Nutella"+sampleNum+"End")).append($("<th/>",{
"data-sample":sampleNum
}).append("Nutella"+sampleNum+"Consumption"))},
makeSampleInfo:function(sampleNum){
var $div=$(".sampleInfoDiv"),labelClass="col-12 col-lg-6 font-weight-bold mt-2",inputClass="col-12 col-lg-6 mt-lg-2"
;$div.append($("<div/>",{
class:"col-12 col-md-6 mt-2",
"data-sample":sampleNum}).append($("<div/>",{
class:"card sampleInfo","data-sample":sampleNum
}).append($("<button></button>",{type:"button",
class:"card-header"}).on("click",e=>{
this.toggleCard($(e.currentTarget))
}).append("Sample "+sampleNum)).append($("<div/>",{
class:"card-body row collapse"
}).append($("<div/>",{class:labelClass
}).append($("<label></label>",{
for:"sampleTime"+sampleNum
}).append("Exp Hour:"))).append($("<div/>",{
class:inputClass}).append($("<input/>",{
type:"number",name:"sampletime"+sampleNum,
id:"sampleTime"+sampleNum,
class:"sampleTime fullWidth watch",
"data-sample":sampleNum,"data-watch":"sampleTime"
}).on("input",e=>{
this.watchSampleLabel($(e.currentTarget).data("sample"))
}))).append($("<div/>",{class:labelClass
}).append($("<label></label>",{
for:"sampleLabel"+sampleNum
}).append("Sample Label:"))).append($("<div/>",{
class:inputClass}).append($("<input/>",{
type:"text",name:"samplelabel"+sampleNum,
id:"sampleLabel"+sampleNum,
class:"sampleLabel fullWidth watch",
"data-sample":sampleNum,"data-watch":"sampleLabel"
}).on("input",e=>{
this.watchSampleLabel($(e.currentTarget).data("sample"))
}))).append($("<div/>",{class:labelClass
}).append($("<label></label>",{
for:"nutellaAtTime"+sampleNum
}).append("Administer Nutella?"))).append($("<div/>",{
class:inputClass}).append($("<input/>",{
type:"checkbox",name:"nutellaattime"+sampleNum,
id:"nutellaAtTime"+sampleNum,
"data-sample":sampleNum,
class:"nutellaAtTime watch",
"data-watch":"nutellaAtTime"}).on("change",e=>{
var sampleSearch=this.sampleSearch(sampleNum)
;if($(e.currentTarget).is(":checked"))$(".ifNutella"+sampleSearch).show();else $(".ifNutella"+sampleSearch).hide()
;this.resize()}))).append($("<div/>",{
class:labelClass
}).append("Sample for:")).append($("<div/>",{
class:inputClass}).append($("<div/>",{class:"row"
}).append($("<div/>",{class:"col"
}).append($("<label></label>",{
for:"cort"+sampleNum
}).append("Cort: ")).append($("<input/>",{
type:"checkbox",name:"cort"+sampleNum,
id:"cort"+sampleNum,"data-sample":sampleNum,
class:"cort watch","data-watch":"cort"
}).on("change",e=>{
this.adjustForSampling(sampleNum)
}))).append($("<div/>",{class:"col"
}).append($("<label></label>",{for:"LH"+sampleNum
}).append("LH: ")).append($("<input/>",{
type:"checkbox",name:"lh"+sampleNum,
id:"LH"+sampleNum,"data-sample":sampleNum,
class:"LH watch","data-watch":"LH"
}).on("change",e=>{
this.adjustForSampling(sampleNum)
;var sampleSearch=this.sampleSearch(sampleNum)
;if($(e.currentTarget).is(":checked"))$(".ifLH"+sampleSearch).show();else $(".ifLH"+sampleSearch).hide()
})))).append($("<div/>",{class:"row"
}).append($("<div/>",{class:"col"
}).append($("<label></label>",{
for:"otherSample"+sampleNum
}).append("Other: ")).append($("<input/>",{
type:"checkbox",name:"othersample"+sampleNum,
id:"otherSample"+sampleNum,
"data-sample":sampleNum,class:"otherSample"
}).on("change",e=>{
this.showIfOtherCheck($(e.currentTarget)),this.adjustForSampling(sampleNum)
})).append($("<input/>",{type:"text",
name:"othername"+sampleNum,
id:"otherName"+sampleNum,"data-sample":sampleNum,
class:"otherName ifOther fullWidth watch",
"data-watch":"otherName"}))))))))},
makeSamplingCard:function(sampleNum){
var $div=$("#samplesAccordion")
;$div.append($("<div/>",{
class:"card samplingCard","data-sample":sampleNum
}).append($("<button></button>",{type:"button",
class:"card-header samplingHead",
id:"samplingHead"+sampleNum}).on("click",e=>{
this.toggleCard($(e.currentTarget))
}).append($("<h4/>",{class:"mb-0"
}).append($("<div/>",{class:"sampleLabelCalc",
"data-sample":sampleNum
}).append("Sample "+sampleNum)))).append($("<div/>",{
class:"samplingBody collapse",
id:"samplingBody"+sampleNum,
"data-sample":sampleNum}).append($("<div/>",{
class:"card-body divForMouseSampling",
"data-sample":sampleNum}))))},
makeSampleForMouse:function(sampleNum,mouseNum){
var sampleSearch=this.sampleSearch(sampleNum),$div=$(".divForMouseSampling"+sampleSearch),sampMouseID=sampleNum+"_"+mouseNum
;$div.append($("<div/>",{
class:"card mouseSampleCard",
"data-sample":sampleNum,"data-mouse":mouseNum
}).append($("<button></button>",{type:"button",
class:"card-header",id:"heading"+sampMouseID
}).on("click",e=>{
this.toggleCard($(e.currentTarget))
}).append($("<h4/>",{class:"mb-0"
}).append($("<div/>",{}).append($("<span/>",{
class:"mouseIDCalc","data-mouse":mouseNum
}).append("[Enter Mouse ID]")).append($("<span/>",{
class:"shortIDCalc","data-mouse":mouseNum
}).append("[Enter Short ID]"))))).append($("<div/>",{
id:"body"+sampMouseID,class:"collapse"
}).append($("<div/>",{class:"card-body container",
"data-mouse":mouseNum,"data-sample":sampleNum
}).append($("<div></div>",{class:"ifSampling",
"data-sample":sampleNum
}).append(this.makeTimeButtonRow(sampMouseID,mouseNum,sampleNum,"Time"))).append($("<div/>",{
class:"row mt-2"}).append($("<div/>",{
class:"col-12 col-md-6"}).append($("<select/>",{
id:"behaviorNotes"+sampMouseID,
name:"behaviornotes"+sampMouseID,
class:"behaviorNotes fullWidth",
"data-mouse":mouseNum,"data-sample":sampleNum
}).append('<option value="">[Select]</option><option value="calm">Calm</option><option value="jumpy">Jumpy</option><option value="exploring">Exploring</option><option value="hunched">Hunched</option>')).append($("<input/>",{
type:"button",value:"Add notes",
id:"addNotes"+sampMouseID,
name:"addnotes"+sampMouseID,
class:"addNotes fullWidth disableOnView",
"data-sample":sampleNum,"data-mouse":mouseNum
}).on("click",e=>{
var thisMouseNum=$(e.currentTarget).data("mouse"),thisSampleNum=$(e.currentTarget).data("sample"),mouseSearch=this.mouseSearch(mouseNum),sampleSearch=this.sampleSearch(sampleNum),selectedBehavior=$(".behaviorNotes"+mouseSearch+sampleSearch).find("option:selected").text()
;if("[Select]"==selectedBehavior)selectedBehavior=""
;var currentVal=$(".notes"+mouseSearch+sampleSearch).val()
;if(currentVal)currentVal+="\n"
;$(".notes"+mouseSearch+sampleSearch).val(currentVal+selectedBehavior)
;var notesTxtbox=document.getElementById("notes"+thisSampleNum+"_"+thisMouseNum)
;notesTxtbox.style.height="auto",
notesTxtbox.style.height=notesTxtbox.scrollHeight+"px",
this.resize()}))).append($("<div/>",{
class:"col-12 col-md-6 mt-2 mt-md-0"
}).append($("<text"+"area></text"+"area>",{
id:"notes"+sampMouseID,name:"notes"+sampMouseID,
class:"notes fullWidth autoAdjust",
placeholder:"Notes","data-mouse":mouseNum,
"data-sample":sampleNum}).on("input",e=>{
e.currentTarget.style.height="auto",e.currentTarget.style.height=e.currentTarget.scrollHeight+"px",
this.resize()})))).append($("<div/>",{
class:"ifLH","data-sample":sampleNum
}).append($("<div/>",{class:"row mt-2"
}).append($("<div/>",{class:"col-12 col-md-6"
}).append($("<label></label>",{
for:"lhnum"+sampMouseID
}).append("LH Sample ID"))).append($("<div/>",{
class:"col-12 col-md-6 mt-2 mt-md-0"
}).append($("<input></input>",{type:"number",
id:"lhnum"+sampMouseID,name:"lhnum"+sampMouseID,
class:"lhnum fullWidth","data-mouse":mouseNum,
"data-sample":sampleNum
}))))).append($("<div></div>",{class:"ifNutella",
"data-sample":sampleNum
}).append(this.makeTimeButtonRow(sampMouseID,mouseNum,sampleNum,"Nutella")).append($("<div/>",{
class:"row mt-2"}).append($("<div/>",{
class:"col-12 col-md-6"
}).append("Nutella consumption:")).append($("<div/>",{
class:"col-12 col-md-6 mt-2 mt-md-0"
}).append($("<select></select>",{
id:"nutellaConsumption"+sampMouseID,
name:"nutellaconsumption"+sampMouseID,
class:"nutellaConsumption fullWidth watch",
"data-mouse":mouseNum,"data-sample":sampleNum,
"data-watch":"nutellaConsumption"
}).append($("<option></option>",{value:""
}).append("[select]")).append($("<option></option>",{
value:"none"
}).append("None")).append($("<option></option>",{
value:"some"
}).append("Some")).append($("<option></option>",{
value:"all"}).append("All")))))))))
;var $mouseTable=$("#mouseTable"),mouseSearch=this.mouseSearch(mouseNum)
;$mouseTable.find("tr"+mouseSearch).append($("<td/>",{
"data-calc":"startTime","data-mouse":mouseNum,
"data-sample":sampleNum})).append($("<td/>",{
"data-calc":"endTime","data-mouse":mouseNum,
"data-sample":sampleNum})).append($("<td/>",{
"data-calc":"startNutella","data-mouse":mouseNum,
"data-sample":sampleNum})).append($("<td/>",{
"data-calc":"endNutella","data-mouse":mouseNum,
"data-sample":sampleNum})).append($("<td/>",{
"data-calc":"nutellaConsumption",
"data-mouse":mouseNum,"data-sample":sampleNum}))},
makeOneTimeEntry:function(sampMouseID,mouseNum,sampleNum,className,timing){
var lowerCaseName=className.toLowerCase(),lowerCaseTime=timing.toLowerCase(),$timeDiv=$("<div/>",{
class:"col-12 col-md-6"
}).append($("<input></input>",{type:"button",
value:timing+" "+className,
id:lowerCaseTime+className+"Button"+sampMouseID,
name:lowerCaseTime+lowerCaseName+"button"+sampMouseID,
class:lowerCaseTime+className+"Button fullWidth disableOnView",
"data-mouse":mouseNum,"data-sample":sampleNum
}).on("click",e=>{
this.updateTimeButton($(e.currentTarget),lowerCaseTime+className)
})).append($("<input></input>",{type:"time",
id:lowerCaseTime+className+sampMouseID,
name:lowerCaseTime+lowerCaseName+sampMouseID,
class:lowerCaseTime+className+" fullWidth watch",
"data-mouse":mouseNum,"data-sample":sampleNum,
placeholder:"hh:mm",
"data-watch":lowerCaseTime+className
}).each((i,e)=>{this.checkTimeFormat($(e))
}).on("change",e=>{
this.checkTimeFormat($(e.currentTarget))}))
;return $timeDiv},
makeTimeButtonRow:function(sampMouseID,mouseNum,sampleNum,className){
var $div=$("<div></div>",{class:"row mt-2"
}).append(this.makeOneTimeEntry(sampMouseID,mouseNum,sampleNum,className,"Start")).append(this.makeOneTimeEntry(sampMouseID,mouseNum,sampleNum,className,"End"))
;return $div},
updateTimeButton:function($el,updateClass){
var thisMouseNum=$el.data("mouse"),thisSampleNum=$el.data("sample"),mouseSearch=this.mouseSearch(thisMouseNum),sampleSearch=this.sampleSearch(thisSampleNum),currentTime=luxon.DateTime.now(),timeString=currentTime.toLocaleString({
...luxon.DateTime.TIME_24_SIMPLE,locale:"en-GB"
}),proceed=true,$updateEl=$("."+updateClass+mouseSearch+sampleSearch)
;if($updateEl.val())proceed=confirm("Are you sure that you want to replace the time?")
;if(proceed)$updateEl.val(timeString),
this.watchValue($updateEl),this.checkTimeFormat($updateEl)
;this.resize()},
checkMiceInSamples:function(sampleNum,mouseNum){
var sampleNumArray=this.miceInSamples[sampleNum],inSample=this.checkInArray(mouseNum,sampleNumArray)
;return inSample},
dataSearch:function(dataName,dataValue){
var dataSearch="[data-"+dataName+"='"+dataValue+"']"
;return dataSearch},
mouseSearch:function(mouseNum){
var mouseSearch=this.dataSearch("mouse",mouseNum)
;return mouseSearch},
sampleSearch:function(sampleNum){
var sampleSearch=this.dataSearch("sample",sampleNum)
;return sampleSearch},tableSearch:function(table){
var tableSearch=this.dataSearch("table",table)
;return tableSearch},calcSearch:function(calc){
var calcSearch=this.dataSearch("calc",calc)
;return calcSearch},doseSearch:function(dose){
var doseSearch=this.dataSearch("dose",dose)
;return doseSearch},
showWithCheck:function($chbx,$toToggle){
if($chbx.is(":checked"))$toToggle.show();else $toToggle.hide().html("")
;this.resize()},showIfOtherCheck:function($chbx){
var $ifOther=$chbx.next(".ifOther")
;this.showWithCheck($chbx,$ifOther)},
toggleTableFuncs:function($table,$errorMsg){
this.data_valid_form($errorMsg),$table.toggle(),
this.resize()},
toCSVFuncs:function(fileName,tableID,$errorMsg){
var data_valid=this.data_valid_form($errorMsg)
;if(data_valid)this.exportTableToCSV(fileName,tableID),
$errorMsg.html("<span style='color:grey; font-size:24px;'>Saved successfully</span>");else $errorMsg.append("<br/><span style='color:grey; font-size:24px;'>Did not export</span>")
},downloadCSV:function(csv,filename){
var csvFile,downloadLink;csvFile=new Blob([csv],{
type:"text/csv"
}),downloadLink=document.createElement("a"),downloadLink.download=filename,
downloadLink.href=window.URL.createObjectURL(csvFile),
downloadLink.style.display="none",
document.body.appendChild(downloadLink),downloadLink.click()
},exportTableToCSV:function(filename,table){
var tableArray=this.getTableArray($("#"+table),copyHead=true,transpose=false),tableString=this.convertRowArrayToString(tableArray,",","\n")
;this.downloadCSV(tableString,filename)},
copyDataFuncs:function($copyHead,$tableToCopy,$tableDiv,$errorMsg,$divForCopy,$transpose){
var data_valid=this.data_valid_form($errorMsg),copyHead=false,transpose=false
;if($copyHead.is(":checked"))copyHead=true
;if(data_valid)$tableDiv.show(),this.resize(),
$errorMsg.html("<span style='color:grey; font-size:24px;'>Copied successfully</span>"),
this.copyTable($tableToCopy,copyHead,$divForCopy,$errorMsg,transpose);else $errorMsg.append("<br/><span style='color:grey; font-size:24px;'>Nothing was copied</span>")
},
copyTable:function($table,copyHead,$divForCopy,$errorMsg,transpose){
var tableArray=this.getTableArray($table,copyHead,transpose),tableString=this.convertRowArrayToString(tableArray,"\t","\n")
;this.copyStringToClipboard(tableString,$divForCopy,$errorMsg)
},
getTableArray:function($table,copyHead,transpose){
var rows=[],rowNum=0
;if(copyHead)$table.find("thead").children("tr").each((i,e)=>{
if(transpose)rowNum=0
;if($(e).find("td, th").each((i,e)=>{
if(void 0===rows[rowNum])rows[rowNum]=[]
;if(rows[rowNum].push($(e).text()),transpose)rowNum++
}),!transpose)rowNum++})
;return $table.find("tbody").children("tr").each((i,e)=>{
if(transpose)rowNum=0
;if($(e).find("td, th").each((i,e)=>{
if(void 0===rows[rowNum])rows[rowNum]=[]
;if(rows[rowNum].push($(e).text()),transpose)rowNum++
}),!transpose)rowNum++}),rows},
convertRowArrayToString:function(rowArray,cellSepString="\t",newRowString="\n"){
var rowString=[];rowArray.forEach(row=>{
if(row.length)row.forEach((cell,i)=>{
if(cell.includes(cellSepString)||cell.includes(newRowString))row[i]='"'+cell+'"'
}),rowString.push(row.join(cellSepString))})
;var tableString=rowString.join(newRowString)
;return tableString},
copyStringToClipboard:function(textStr,$divForCopy,$errorMsg){
var $temp=$("<text"+"area style='opacity:0;'></text"+"area>")
;if(textStr)errorStr="Copy attempted",
$errorMsg.html("<span style='color:grey; font-size:24px;'>Copy attempted</span>");else textStr=" ",
$errorMsg.html("<span style='color:red; font-size:24px;'>Nothing to copy</span>")
;$temp.text(textStr),
$temp.appendTo($divForCopy).select(),document.execCommand("copy"),
$temp.remove(),this.resize()},
copyLHSampleNums:function($divForCopy,$errorMsg){
var table=this.getLHSampleNums()
;this.copyStringToClipboard(table,$divForCopy,$errorMsg)
},
copyNutellaEating:function($divForCopy,$errorMsg){
var table=this.getNutellaEating()
;this.copyStringToClipboard(table,$divForCopy,$errorMsg)
},getLHSampleNums:function(){
var mice=[],times=[],LHIDs=[]
;for(var mouseNum of this.mouseNums){
var mouseSearch=this.mouseSearch(mouseNum),mouseID=$(".mouseID"+mouseSearch).val()
;if(!mouseID)mouseID=""
;for(var sampleNum of this.sampleNums){
var sampleSearch=this.sampleSearch(sampleNum),time=$(".sampleTime"+sampleSearch).val()
;if(time)time=parseFloat(time);else time=""
;if($(".LH"+sampleSearch).is(":checked")){
var LHID=$(".lhnum"+sampleSearch+mouseSearch).val()
;mice.push(mouseID),times.push(time),
LHIDs.push(LHID)}}}var table=[],columnJoin="\t"
;table=this.zip(mice,times,LHIDs)
;for(var row=0;row<table.length;row++)table[row]=table[row].join(columnJoin)
;return table.join("\n")},
getNutellaEating:function(){
var mice=[],times=[],nutellaNotes=[]
;for(var mouseNum of this.mouseNums){
var mouseSearch=this.mouseSearch(mouseNum),mouseID=$(".mouseID"+mouseSearch).val()
;if(!mouseID)mouseID=""
;for(var sampleNum of this.sampleNums){
var sampleSearch=this.sampleSearch(sampleNum),time=$(".sampleTime"+sampleSearch).val()
;if(time)time=parseFloat(time);else time=""
;if($(".nutellaAtTime"+sampleSearch).is(":checked")){
var nutellaNote=$(".nutellaConsumption"+sampleSearch+mouseSearch).val()
;mice.push(mouseID),
times.push(time),nutellaNotes.push(nutellaNote)}}}
var table=[],columnJoin="\t"
;table=this.zip(mice,times,nutellaNotes)
;for(var row=0;row<table.length;row++)table[row]=table[row].join(columnJoin)
;return table.join("\n")},zip:function(...args){
var len=0,array;for(array of args){
var arrLen=array.length;if(arrLen>len)len=arrLen}
for(var numArrays=args.length,arr=new Array(len),i=0;i<len;i+=1)for(array of(arr[i]=[],
args))arr[i].push(array[i]);return arr},
getOffsetTop:function(element){
var offsetTop=0,lastElement=0
;while(element&&!lastElement){
var formChild=$(element).children("#the_form")
;if(formChild.length>0)lastElement=1
;offsetTop+=element.offsetTop,element=element.offsetParent
}return offsetTop},
runIfConfirmed:function(text,functionToCall,elForHeight=null){
var thisMessage="Are you sure?"
;if(text)thisMessage=text;var top="auto"
;if(elForHeight)top=this.getOffsetTop(elForHeight)+"px"
;bootbox.confirm({message:thisMessage,
callback:proceed=>{if(proceed)functionToCall()}
}),$(".modal-dialog").css("top",top)},
dialogConfirm:function(text,functionToCall,elForHeight=null){
var thisMessage="Do you want to proceed?"
;if(text)thisMessage=text;var top="auto"
;if(elForHeight)top=this.getOffsetTop(elForHeight)+"px"
;bootbox.confirm({message:thisMessage,
callback:result=>{functionToCall(result)}
}),$(".modal-dialog").css("top",top)},
runBasedOnInput:function(prompt,functionToCall,elForHeight=null){
var thisTitle="Enter value:"
;if(prompt)thisTitle=prompt;var top="auto"
;if(elForHeight)top=this.getOffsetTop(elForHeight)+"px"
;bootbox.prompt({title:thisTitle,
callback:result=>{functionToCall(result)}
}),$(".modal-dialog").css("top",top)}};