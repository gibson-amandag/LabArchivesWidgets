my_widget_script={mouseNums:[],startTime:"",
init:function(mode,json_data){
var parsedJson=this.parseInitJson(json_data)
;this.initDynamicContent(parsedJson),
window.onresize=this.resize,this.addEventListeners(),
this.parent_class.init(mode,()=>JSON.stringify(parsedJson.widgetData)),
this.addRequiredFieldIndicators(),
this.setUpInitialState(),this.adjustForMode(mode)
},to_json:function(){
var widgetJsonString=this.parent_class.to_json(),dynamicContent=this.getDynamicContent(),output={
widgetData:JSON.parse(widgetJsonString),
mouseNums:my_widget_script.mouseNums}
;return JSON.stringify(output)},
from_json:function(json_data){
var parsedJson=JSON.parse(json_data)
;this.parent_class.from_json(JSON.stringify(parsedJson.widgetData))
},test_data:function(){
var testData=JSON.parse(this.parent_class.test_data()),output={
widgetData:testData,mouseNums:[2,4]}
;return JSON.stringify(output)},
is_valid:function(b_suppress_message){
var fail=false,fail_log="",name
;if($("#the_form").find("select, textarea, input").each(function(){
if(!$(this).prop("required"));else if(!$(this).val())fail=true,
name=$(this).attr("id"),
fail_log+=name+" is required \n"
}),$("input[type='date']").each(function(){
var date=$(this).val();if(date){
var validDate=my_widget_script.isValidDate(date)
;if(!validDate)fail=true,fail_log+="Please enter valid date in form 'YYYY-MM-DD'"
}}),$("input[type='time']").each(function(){
var time=$(this).val();if(time){
var validtime=my_widget_script.isValidTime(time)
;if(!validtime)fail=true,fail_log+="Please enter valid time in form 'hh:mm' - 24 hr time"
}}),fail)return alert(fail_log);else{
var noErrors=[];return noErrors}},
is_edited:function(){
return this.parent_class.is_edited()},
reset_edited:function(){
return this.parent_class.reset_edited()},
parseInitJson:function(json_data){var jsonString
;if("string"===typeof json_data)jsonString=json_data;else jsonString=json_data()
;var parsedJson=JSON.parse(jsonString)
;return parsedJson},
initDynamicContent:function(parsedJson){
if(parsedJson.mouseNums)for(var i=0;i<parsedJson.mouseNums.length;i++){
var mouse=parsedJson.mouseNums[i]
;my_widget_script.makeMouseCard(mouse)}},
adjustForMode:function(mode){
if("edit"!==mode&&"edit_dev"!==mode)$(".disableOnView").prop("disabled",true),
$(".hideView").hide(),
$("input[type='date']").removeClass(".hasDatePicker"),$(".card-header").each(function(){
my_widget_script.toggleCard($(this))
});else $("input[type='date']").each(function(){
my_widget_script.checkDateFormat($(this))
}),$("input[type='time']").each(function(){
my_widget_script.checkTimeFormat($(this))})},
addEventListeners:function(){},
addRequiredFieldIndicators:function(){
$(".needForTableLab").each(function(){
$(this).html("<span style='color:blue'>#</span>"+$(this).html())
}),$(".requiredLab").each(function(){
$(this).html("<span style='color:red'>*</span>"+$(this).html())
})},isValidTime:function(timeString){
var regEx="^(((([0-1][0-9])|(2[0-3])):[0-5][0-9]))$"
;if(!timeString.match(regEx))return false;else return true
},isTimeSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","time")
;var supported=true
;if("time"!==input.type)supported=false
;return my_widget_script.timeSupported=supported,
input.remove(),supported},timeSupported:true,
checkTimeFormat:function($timeInput){
if(!my_widget_script.timeSupported){
$timeInput.next(".timeWarning").remove()
;var time=$timeInput.val(),isValid=my_widget_script.isValidTime(time)
;if(!isValid)$timeInput.after('<div class="text-danger timeWarning">Enter time as "hh:mm" in 24-hr format</div>')
;my_widget_script.resize()}},
isValidDate:function(dateString){
var regEx=/^\d{4}-\d{2}-\d{2}$/
;if(!dateString.match(regEx))return false
;var d=new Date(dateString),dNum=d.getTime()
;if(!dNum&&0!==dNum)return false
;return d.toISOString().slice(0,10)===dateString},
isDateSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","date")
;var supported=true
;if("date"!==input.type)supported=false
;return my_widget_script.dateSupported=supported,
input.remove(),supported},dateSupported:true,
checkDateFormat:function($dateInput){
if(!my_widget_script.dateSupported){
$dateInput.next(".dateWarning").remove()
;var date=$dateInput.val(),isValid=my_widget_script.isValidDate(date)
;if(!isValid)$dateInput.after('<div class="text-danger dateWarning">Enter date as "YYYY-MM-DD"</div>')
;$dateInput.datepicker({dateFormat:"yy-mm-dd"
}),my_widget_script.resize()}},
setUpInitialState:function(){
$(".myLeftCol").addClass("col-12 col-sm-6 col-md-4 col-lg-3 text-left text-sm-right"),
my_widget_script.isDateSupported(),
my_widget_script.isTimeSupported(),$("input[type='date']").prop("placeholder","YYYY-MM-DD").on("change",function(){
my_widget_script.checkDateFormat($(this))
}),$("input[type='time']").prop("placeholder","hh:mm").on("change",function(){
my_widget_script.checkTimeFormat($(this))
}),$("textarea.autoAdjust").each(function(){
var height=this.scrollHeight;if(0==height){
text=$(this).val(),$(".forTextBox").show(),
$("#forSizing").val(text)
;var forSizing=document.getElementById("forSizing")
;height=forSizing.scrollHeight,
$(".forTextBox").hide()}
this.setAttribute("style","height:"+height+"px;overflow-y:hidden;")
}).on("input",function(){
this.style.height="auto",this.style.height=this.scrollHeight+"px",
my_widget_script.resize()
}),$("#addMouse").on("click",function(){
if(my_widget_script.mouseNums.length>0)var lastMouse=my_widget_script.mouseNums[my_widget_script.mouseNums.length-1],mouseNum=lastMouse+1;else var mouseNum=1
;my_widget_script.makeMouseCard(mouseNum)
}),$("#timeZone").each(function(){
if("est"==$(this).val())my_widget_script.startTime=luxon.DateTime.fromObject({
hour:9,minute:30
});else my_widget_script.startTime=luxon.DateTime.fromObject({
hour:10,minute:30})}).on("change",function(){
if("est"==$(this).val())my_widget_script.startTime=luxon.DateTime.fromObject({
hour:9,minute:30
});else my_widget_script.startTime=luxon.DateTime.fromObject({
hour:10,minute:30})
}),$.each(my_widget_script.mouseNums,function(){
my_widget_script.watchMouseID(this)
}),my_widget_script.resize()},resize:function(){
my_widget_script.parent_class.resize_container()},
getDynamicContent:function(){var dynamicContent={}
;return dynamicContent},
data_valid_form:function(){var valid=true
;if($(".needForTable").each(function(){
if(!$(this).val())valid=false
}),!valid)$("#errorMsg").html("<span style='color:red; font-size:36px;'>Please fill out all elements marked by a</span><span style='color:blue; font-size:36px;'> blue #</span>");else $("#errorMsg").html("")
;return valid},
dataSearch:function(dataName,dataValue){
var dataSearch="[data-"+dataName+"='"+dataValue+"']"
;return dataSearch},
mouseSearch:function(mouseNum){
var mouseSearch=my_widget_script.dataSearch("mouse",mouseNum)
;return mouseSearch},
checkInArray:function(searchVal,array){
var proceed=-1!==$.inArray(searchVal,array)
;return proceed},toggleCard:function($cardHead){
$cardHead.next().toggleClass("collapse"),
$cardHead.find("textarea.autoAdjust").each(function(){
if(!$(this).is(":hidden"))this.setAttribute("style","height:"+this.scrollHeight+"px;overflow-y:hidden;")
}),my_widget_script.resize()},
makeCard:function($div,cardHeadContent,cardBodyContent){
$div.append($("<div/>",{class:"card"
}).append($("<button></button>",{type:"button",
class:"card-header"}).on("click",function(){
my_widget_script.toggleCard($(this))
}).append(cardHeadContent)).append($("<div/>",{
class:"card-body collapse"
}).append(cardBodyContent))),my_widget_script.resize()
},makeMouseCard:function(mouseNum){
var inArray=my_widget_script.checkInArray(mouseNum,my_widget_script.mouseNums)
;if(!inArray){
my_widget_script.mouseNums.push(mouseNum)
;var $div=$(".mouseInfo")
;if(!$div.find(".card").length)$div.html("")
;var row="row mt-2",col="col-12 col-lg-6"
;$div.append($("<div/>",{
class:"col-12 col-lg-6 mt-2 mouseCard",
"data-mouse":mouseNum}))
;var mouseSearch=my_widget_script.mouseSearch(mouseNum),$divFoCard=$div.find(".mouseCard"+mouseSearch),headContent=$("<div/>",{
class:"mouseIDCalc","data-mouse":mouseNum
}).append("Mouse "+mouseNum),bodyContent=$("<div/>").append($("<div/>",{
class:row+" hideView"}).append($("<div/>",{
class:col
}).append("<h4>Mouse ID:</h4>")).append($("<div/>",{
class:"col"}).append($("<input/>",{type:"text",
"data-mouse":mouseNum,id:"mouseID"+mouseNum,
name:"mouseid"+mouseNum,class:"mouseID fullWidth"
}).on("input",function(){
my_widget_script.watchMouseID($(this).data("mouse"))
})))).append($("<div/>",{class:row+" hideView"
}).append($("<div/>",{class:col
}).append("Delete:")).append($("<div/>",{
class:"col"}).append($("<input/>",{type:"button",
value:"Delete Mouse","data-mouse":mouseNum,
id:"deleteMouse"+mouseNum,
name:"deletemouse"+mouseNum,
class:"deleteMouse fullWidth"
}).on("click",function(){
my_widget_script.deleteMouseFuncs($(this).data("mouse"))
})))).append($("<div/>",{class:row
}).append($("<div/>",{class:"col-12 hideView"
}).append($("<select/>",{
id:"behaviorNotes"+mouseNum,
name:"behaviornotes"+mouseNum,
class:"behaviorNotes fullWidth",
"data-mouse":mouseNum,multiple:true
})).append($("<input/>",{type:"button",
value:"Add notes",id:"addNotes"+mouseNum,
name:"addnotes"+mouseNum,
class:"addNotes fullWidth disableOnView",
"data-mouse":mouseNum}).on("click",function(){
var thisMouseNum=$(this).data("mouse"),mouseSearch=my_widget_script.mouseSearch(mouseNum),notes=$(".notes"+mouseSearch).val(),addLine=""
;if(notes)addLine="\n"
;notes+=addLine+"------\n",currentTime=luxon.DateTime.now().setLocale("en-US"),
notes+=currentTime.toLocaleString(luxon.DateTime.TIME_24_WITH_SHORT_OFFSET)+": "
;var diffInHours=currentTime.diff(my_widget_script.startTime).as("hours")
;notes+=diffInHours.toFixed(1)+"h";var addComma=""
;addLine="\n",$(".behaviorNotes"+mouseSearch).find("option:selected").each(function(){
notes+=addLine+addComma+$(this).text(),
addComma=", ",addLine=""
}),$(".notes"+mouseSearch).val(notes)
;var notesTxtbox=document.getElementById("notes"+thisMouseNum)
;notesTxtbox.style.height="auto",
notesTxtbox.style.height=notesTxtbox.scrollHeight+"px",
my_widget_script.resize()}))).append($("<div/>",{
class:"col-12 mt-2"
}).append($("<text"+"area></text"+"area>",{
id:"notes"+mouseNum,name:"notes"+mouseNum,
class:"notes fullWidth autoAdjust",
placeholder:"Notes","data-mouse":mouseNum
}).on("input",function(){
this.style.height="auto",this.style.height=this.scrollHeight+"px",
my_widget_script.resize()}))))
;my_widget_script.makeCard($divFoCard,headContent,bodyContent)
;for(var behaviorOptions=[{val:"moved",
text:"Moved to new room"},{val:"restraint",
text:"Placed in restraint tube"},{val:"scent",
text:"Added 2,3-TMT scent"},{val:"digging",
text:"Digging"},{val:"grooming",text:"Grooming"},{
val:"rearing",text:"Rearing"},{val:"biting",
text:"Biting plastic"},{val:"resting",
text:"Resting"},{val:"twisting",
text:"Twisting/turning"
}],i=0;i<behaviorOptions.length;i++){
var option=behaviorOptions[i],val=option.val,text=option.text
;$(".behaviorNotes"+mouseSearch).append($("<option/>",{
value:val}).append(text))}}},
watchMouseID:function(mouseNum){
var mouseSearch=my_widget_script.mouseSearch(mouseNum),mouseID=$(".mouseID"+mouseSearch).val()
;if(!mouseID)mouseID="Mouse "+mouseNum
;$(".mouseIDCalc"+mouseSearch).html(mouseID)},
deleteMouseFuncs:function(mouseNum){
var index=my_widget_script.mouseNums.indexOf(mouseNum)
;if(index>-1)my_widget_script.mouseNums.splice(index,1)
;var mouseSearch=my_widget_script.mouseSearch(mouseNum)
;$(".mouseCard"+mouseSearch).remove(),
my_widget_script.resize()}};