<html>

<head>
    <link rel="stylesheet" href="styles.css">
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            //Show/hide the table
            $("#toggleTable").click(function () { //when the showTable button is clicked. Run this function
                //alert("button pressed");
                //Get width
                var width = window.innerWidth;
                $(".tableDiv").width(width * .95); //make width 95% of current width
                $("#tableDiv").toggle();
                my_widget_script.parent_class.resize_container();
            });

            //Show/hide elements based on sex
            $("#sex").change(function () { //when sex is changed
                if ($("#sex").val() === "female") {
                    $(".female").show() //show female class elements
                    $(".male").hide() //hide male class elements
                    if ($("#gonadstatus").val() === "intact") {
                        $(".cycle").show() //only show cycle if intact is also true
                    } else {
                        $(".cycle").hide()
                    }
                } else {
                    $(".female").hide() //hide female class elements
                    $(".male").show() //show male class elements
                    $(".cycle").hide() //hide cycles for male
                }
            });

            //Show/hide elements based on gonad status
            $("#gonadstatus").change(function () { //when gonad status is changed
                if ($("#gonadstatus").val() === "intact") {
                    $(".intact").show() //show intact class elements
                    $(".gdx").hide() //hide gdx class elements
                    if ($("#sex").val() === "female") {
                        $(".cycle").show()
                    } else {
                        $(".cycle").hide()
                    }
                } else {
                    $(".intact").hide() //hide intact class elements
                    $(".gdx").show() //show gdx class elements
                    $(".cycle").hide()
                }
            });

            //when the calculate button is clicked, run the calcValues function
            $('#calculate').click(function () {//seems to be the best way to actually get this to run when clicked. Anonymous function. Call the real function inside
                calcValues();
            });

            //when the size of the window changes, run the resize function
            //window.onresize = my_widget_script.resize;
        });

        function implantChecked() {
            if ($("#implantBox").is(":checked")) {
                $(".implant").show() //show implant class elements
            } else {
                $(".implant").hide()
            }
        }

        function calcValues() {
            //Mouse ID
            $("#MouseID_calc").text($("#MouseID").val());

            //Cage number
            $("#Cage_calc").text($("#Cage").val());

            //treatment
            //if want text from selected, instead of value $("#Treatment").children("option:selected").text())
            $("#Treatment_calc").text($("#Treatment").val());
            //generic treatment
            if ($("#Treatment_calc").text() === "CON" || //if Treatment_calc equals CON, CON_main, or VEH,
                $("#Treatment_calc").text() === "CON_main" ||
                $("#Treatment_calc").text() === "VEH") {
                $("#GenTreatment_calc").text("Control"); //GenTreatment_calc equals "Control"
            } else {
                $("#GenTreatment_calc").text("PNA") //else equals "PNA"
            }

            //Cycle stage
            if ($("#sex").val() === "female" && $("#gonadstatus").val() === "intact") { //only for intact females
                $("#CycleStage_calc").text($("#CycleStage").val());
            } else {
                $("#CycleStage_calc").text("NA");
            }

            //body mass
            $("#BodyMass_g_calc").text($("#BodyMass_g").val());

            //uterine mass
            if ($("#sex").val() === "female") {
                $("#UterineMass_calc").text($("#gonadMass").val());
            } else {
                $("#UterineMass_calc").text("NA");
            }
            //uterine mass per body mass
            if ($("#sex").val() === "female") {
                var uterine_mg_per_g = $("#gonadMass").val() / $("#BodyMass_g").val();
                $("#Uterine_mg_per_g_calc").text(uterine_mg_per_g.toFixed(4));
            } else {
                $("#Uterine_mg_per_g_calc").text("NA");
            }

            //Date of birth
            $("#Date_of_birth_calc").text($("#Date_of_birth").val());

            //Recording date
            $("#Recording_date_calc").text($("#Recording_date").val());

            //Age in days
            //https://www.geeksforgeeks.org/how-to-calculate-the-number-of-days-between-two-dates-in-javascript/
            var DOBisDay = 1; //change to 0 if want DOB to be day 0
            var Recording_date_as_ms = new Date($("#Recording_date").val()).getTime();
            var DOB_as_ms = new Date($("#Date_of_birth").val()).getTime();
            var Age_in_days = (Recording_date_as_ms - DOB_as_ms) / (1000 * 3600 * 24) + DOBisDay;
            $("#Age_in_days_calc").text(Age_in_days);

            //saved pituitary
            if ($("#Saved_pit").is(":checked")) {
                var Saved_pit = "Y";
            } else {
                var Saved_pit = "N";
            }
            $("#Saved_pit_calc").text(Saved_pit);

            //Daylight savings
            $("#Daylight_Savings_calc").text($("#Daylight_Savings").val());

            //Time of sacrifice
            $("#Time_sac_calc").text($("#Time_sac").val());

            //Hours since lights on
            //http://jsfiddle.net/44NCk/4/
            var time_sac = $("#Time_sac").val().split(":");
            if ($("#Daylight_Savings").val() === "Y") { //if daylight savings time
                var lights_on = "04:00"; //lights on at 4am
                var lights_on_split = lights_on.split(":");
            } else {
                var lights_on = "03:00" //otherwise, lights on at 3a
                var lights_on_split = lights_on.split(":");
            }
            var hours_sac = parseInt(time_sac[0], 10), //get the hours component for time sac
                hours_lights = parseInt(lights_on_split[0], 10),
                min_sac = parseInt(time_sac[1], 10), //get the min component
                min_lights = parseInt(lights_on_split[1], 10);
            var hours = hours_sac - hours_lights, mins = 0; //subtract time of sac from lights on
            if (hours < 0) hours = 24 + hours; //if a negative number, add 24
            if (min_sac >= min_lights) { //if the min time of sac is greater than min time lights on
                mins = min_sac - min_lights; //subtract as is
            } else {
                mins = (min_sac + 60) - min_lights; //otherwise add 60 min and remove an hour
                hours--;
            }

            mins = mins / 60; //divide min by 60 to get decimal
            hours += mins; //add min to hours
            hours = hours.toFixed(3); //three decimal points
            $("#Sac_hr_calc").text(hours);
            $("#Who_calc").text($("#Who").val());

            $("#outTable tr").each(function () { //for each row
                $("td", this).each(function () { //for each cell
                    var value = $(this).text(); //get the value of the text
                    if (value === "" || value === "NaN" || value === "___") { //if blank or NaN
                        $(this).text("NA"); //make NA
                    }
                })
            });

            //resize the container
            //my_widget_script.parent_class.resize_container();
        }

        function resize() {
            //adding this here ensures that even if table is showing, that it doesn't try to resize with that out of view
            //gets the inner width of the window. Resets the size of the tableDiv. THEN resizes the container
            //var width = window.innerWidth;
            //$(".tableDiv").width(width * .95); //make width of table div 95% of current width

            //resize the container
            //my_widget_script.parent_class.resize_container();
            alert("This would resize within LabArchives");
        }

        function downloadCSV(csv, filename) {
            // source: https://www.codexworld.com/export-html-table-data-to-csv-using-javascript/
            var csvFile;
            var downloadLink;

            // CSV file
            csvFile = new Blob([csv], { type: "text/csv" });

            // Download link
            downloadLink = document.createElement("a");

            // File name
            downloadLink.download = filename;

            // Create a link to the file
            downloadLink.href = window.URL.createObjectURL(csvFile);

            // Hide download link
            downloadLink.style.display = "none";

            // Add the link to DOM
            document.body.appendChild(downloadLink);

            // Click download link
            downloadLink.click();
        }

        function exportTableToCSV(filename, table) {
            // source: https://www.codexworld.com/export-html-table-data-to-csv-using-javascript/
            var csv = [];
            var datatable = document.getElementById(table);
            var rows = datatable.querySelectorAll("tr");

            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll("td, th");

                for (var j = 0; j < cols.length; j++)
                    row.push(cols[j].innerText);

                csv.push(row.join(","));
            }

            // Download CSV file
            this.downloadCSV(csv.join("\n"), filename);
        }

    </script>
</head>

<body>
    <!--Start copy-->
    <h1><span style="font-size:36px;">Slicing</span></h1>

    <div class="columns">
        <div class="column3">
            <div>
                <h3>General Info</h3>
            </div>

            <div class="container">
                <div>Experimenter</div>

                <div><input id="Who" name="who" /></div>

                <div>Date</div>

                <div><input id="Recording_date" name="slicedate" type="date" /></div>

                <div>Time of Sacrifice</div>

                <div><input id="Time_sac" name="sactime" type="time" /></div>

                <div>Daylight Savings Time</div>

                <div><label for="daylightsaving">Select:</label> <select id="Daylight_Savings" name="daylightsaving">
                        <option value="Y">Daylight Savings Time (summer)</option>
                        <option value="N">Standard Time (winter)</option>
                    </select></div>

                <div>
                    <h3>Mouse Information</h3>
                </div>

                <div>&nbsp;</div>

                <div>Mouse ID # or Ear Tag</div>

                <div><input id="MouseID" name="mouseid" value="TestID" /></div>

                <div>Transgenic Line</div>

                <div><input id="strain" name="strain" /></div>

                <div>Zygosity</div>

                <div><label for="zygosity">Select:</label> <select id="zygosity" name="zygosity">
                        <option value="homoPlus">+/+</option>
                        <option value="hetero">+/-</option>
                        <option value="homoNeg">-/-</option>
                    </select></div>

                <div>Cage #</div>

                <div><input id="Cage" name="cagenum" /></div>

                <div>Date of Birth</div>

                <div><input id="Date_of_birth" name="dob" type="date" /></div>

                <div>Treatment</div>

                <div><select id="Treatment" name="treatment">
                        <option value="CON">Control</option>
                        <option value="CON_main">Main colony control</option>
                        <option value="VEH">Vehicle</option>
                        <option value="DHT">DHT</option>
                    </select></div>

                <div>Sex</div>

                <div><label for="sex">Select:</label> <select id="sex" name="sex">
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                    </select></div>

                <div>Body mass (g)</div>

                <div><input id="BodyMass_g" name="bodymass" step="0.1" type="number" value="0.01" /></div>

                <div>
                    <div class="female">Uterine Mass (mg)</div>

                    <div class="male" style="display: none;">Seminal Vesicle Mass (mg)</div>
                </div>

                <div><input id="gonadMass" name="gonadmass" step="0.01" type="number" /></div>

                <div>Blood Glucose (mg/100mL)</div>

                <div><input id="glucose" name="glucose" step="0.001" type="number" /></div>
            </div>
        </div>

        <div class="column3">
            <div>
                <h3>Gonadal Status</h3>
            </div>

            <div class="container">
                <div>Gonad Status</div>

                <div><label for="gonadstatus">Status:</label> <select id="gonadstatus" name="gonadstatus">
                        <option selected="selected" value="intact">Intact</option>
                        <option value="gdx">Gonadectomized</option>
                    </select></div>

                <div class="cycle">Cycle Stage</div>

                <div class="cycle"><label for="cyclestage">Select:</label> <select id="CycleStage" name="cyclestage">
                        <option value="NA">NA</option>
                        <option value="D">Diestrus</option>
                        <option value="P">Proestrus</option>
                        <option value="E">Estrus</option>
                    </select><br />
                    <label for="stagecomment">Comment:</label> <input name="stagecomment" /></div>

                <div class="gdx" style="display: none;">Date of surgery</div>

                <div class="gdx" style="display: none;"><input id="surgerydate" name="surgerydate" type="date" /></div>
            </div>

            <h3>Steroid Implants</h3>

            <div class="container">
                <div>Implant?</div>

                <div><label for="implant">Check if yes:</label> <input id="implantBox" name="implant"
                        onclick="implantChecked()" type="checkbox" /></div>
                <!-- <div><label for="implant">Check if yes:</label> <input id="implantBox" name="implant" onclick="form_script.implantChecked()" type="checkbox" /></div> -->

                <div class="implant">Type of implant</div>

                <div class="implant"><select id="implantType" name="implanttype">
                        <option value="e2">E2</option>
                        <option value="dht">DHT</option>
                        <option value="pira">P IRA</option>
                        <option value="other">Other</option>
                    </select></div>

                <div class="implant">Implant Comment</div>

                <div class="implant"><input name="implantcomment" /></div>

                <div>
                    <h3>Samples</h3>
                </div>

                <div>&nbsp;</div>

                <div>Serum Tube Label</div>

                <div><input id="tubeLabel" name="tubelabel" /></div>

                <div>Pituitary</div>

                <div><label for="pituitary">Saved pituitary</label> <input id="Saved_pit" name="pituitary"
                        type="checkbox" /></div>
            </div>
        </div>

        <div class="column3">
            <div>
                <h3>Slice Info</h3>
            </div>

            <div class="container">
                <div>Nucleus/Area of Interest</div>

                <div><input id="nucleus" name="nucleus" /></div>

                <div>Slicing Orientation</div>

                <div><input id="orientation" name="orientation" /></div>

                <div>Quality</div>

                <div><label for="slicequal">Select:</label> <select id="slicequal" name="slicequal">
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select><br />
                    <label for="slicecomment">Comment:</label> <input name="slicecomment" /></div>

                <div>Fluorescent Quality</div>

                <div><label for="fluorqual">Select:</label> <select id="fluorqual" name="fluorqual">
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select><br />
                    <label for="fluorcomment">Comment:</label> <input name="fluorcomment" /></div>

                <div>
                    <h3>Solutions</h3>
                </div>

                <div>&nbsp;</div>

                <div>External and addition</div>

                <div><input id="externalsoln" name="externalsoln" /></div>

                <div>Internal Solution</div>

                <div><input id="externalsoln" name="internalsoln" /></div>

                <div>Internal Date</div>

                <div><input id="internaldate" name="internaldate" type="date" /></div>

                <div>Pipette</div>

                <div><input id="pipette" name="pipette" /></div>

                <div>Date of pipette solution</div>

                <div><input id="pipette" name="pipettedate" type="date" /></div>

                <div>Pipette Lot</div>

                <div><input id="pipettelot" name="pipettelot" /></div>

                <div>Internal Solution</div>

                <div><input id="internalsoln" name="internalsoln" /></div>
            </div>
        </div>
    </div>
    <!--End columns div-->

    <p>&nbsp;</p>

    <h2>Comments:</h2>

    <p><textarea cols="50%" name="comments" rows="5"></textarea><br />
        <br />

        <!-- testing locally -->
        <input id="toggleTable" name="toggletable" type="button" value="Show/Hide Table" /> <input id="calculate"
            name="calcvalues" type="button" value="Calculate Values" /> <input id="toCSV" name="tocsv"
            onclick="exportTableToCSV('mouseData', 'outTable')" type="button" value="Save CSV" /></p>

    <!-- LabArchives with onclick to form_script -->
    <!-- <input id="toggleTable" name="toggletable" type="button" value="Show/Hide Table" /> <input id="calculate" name="calcvalues" type="button" value="Calculate Values" /> <input id="toCSV" name="tocsv" onclick="form_script.exportTableToCSV('mouseData', 'outTable')" type="button" value="Save CSV" /></p> -->

    <div class="tableDiv" id="tableDiv" style="display:none">
        <table border="1pt" id="outTable">
            <tbody>
                <tr>
                    <th>MouseID</th>
                    <th>Cage</th>
                    <th>Treatment</th>
                    <th>GenTreatment</th>
                    <th>CycleStage</th>
                    <th>BodyMass_g</th>
                    <th>UterineMass</th>
                    <th>Uterine_mg_per_g</th>
                    <th>Date_of_birth</th>
                    <th>Recording_date</th>
                    <th>Age_in_days</th>
                    <th>Saved_pit</th>
                    <th>Daylight_Savings</th>
                    <th>Time_sac</th>
                    <th>Sac_hr</th>
                    <th>Who</th>
                </tr>
                <tr>
                    <td id="MouseID_calc">&nbsp;</td>
                    <td id="Cage_calc">&nbsp;</td>
                    <td id="Treatment_calc">&nbsp;</td>
                    <td id="GenTreatment_calc">&nbsp;</td>
                    <td id="CycleStage_calc">&nbsp;</td>
                    <td id="BodyMass_g_calc">&nbsp;</td>
                    <td id="UterineMass_calc">&nbsp;</td>
                    <td id="Uterine_mg_per_g_calc">&nbsp;</td>
                    <td id="Date_of_birth_calc">&nbsp;</td>
                    <td id="Recording_date_calc">&nbsp;</td>
                    <td id="Age_in_days_calc">&nbsp;</td>
                    <td id="Saved_pit_calc">&nbsp;</td>
                    <td id="Daylight_Savings_calc">&nbsp;</td>
                    <td id="Time_sac_calc">&nbsp;</td>
                    <td id="Sac_hr_calc">&nbsp;</td>
                    <td id="Who_calc">&nbsp;</td>
                </tr>
            </tbody>
        </table>
        <p>&nbsp;</p>
    </div>
    <!--Stop copying here-->
</body>

</html>