my_widget_script={init:function(mode,json_data){this.includeGoogle("https://www.gstatic.com/charts/loader.js",()=>{$(document).ready(()=>{this.include("https://code.jquery.com/jquery-3.5.1.min.js","sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=","anonymous",()=>{$(document).ready(()=>{
this.include("https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js","sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl","anonymous",()=>{$(document).ready(()=>{
this.include("https://cdn.jsdelivr.net/npm/luxon@1.26.0/build/global/luxon.min.js","sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=","anonymous",()=>{$(document).ready(()=>{
this.include("https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js","sha512-RdSPYh1WA6BF0RhpisYJVYkOyTzK4HwofJ3Q7ivt/jkpW6Vc8AurL1R+4AUcvn9IwEKAPm/fk7qFZW3OuiUDeg==","anonymous",()=>{$(document).ready(()=>{$jq351=jQuery.noConflict(true),this.myInit(mode,json_data)})})})})})})})})})
})},includeGoogle:function(src,onload){var head=document.getElementsByTagName("head")[0],script=document.createElement("script");script.src=src,script.type="text/javascript",script.onload=script.onreadystatechange=function(){if(script.readyState){
if("complete"===script.readyState||"loaded"===script.readyState)script.onreadystatechange=null,onload()}else onload()},head.appendChild(script)},include:function(src,integrity,crossorigin,onload){var head=document.getElementsByTagName("head")[0],script=document.createElement("script")
;script.setAttribute("integrity",integrity),script.setAttribute("crossorigin",crossorigin),script.src=src,script.type="text/javascript",script.onload=script.onreadystatechange=function(){if(script.readyState){
if("complete"===script.readyState||"loaded"===script.readyState)script.onreadystatechange=null,onload()}else onload()},head.appendChild(script)},myInit:function(mode,json_data){this.myFunctions();var parsedJson=this.parseInitJson(json_data);this.initDynamicContent(parsedJson),
window.onresize=(()=>this.resize()),window.onresize=(()=>this.makeCharts()),this.addEventListeners(),this.parent_class.init(mode,()=>JSON.stringify(parsedJson.widgetData)),this.addRequiredFieldIndicators(),this.setUpInitialState(),this.adjustForMode(mode),this.checkForNames(),this.makeCharts()},
to_json:function(){var widgetJsonString=this.parent_class.to_json(),dynamicContent=this.getDynamicContent(),output={widgetData:JSON.parse(widgetJsonString),mouseNums:my_widget_script.mouseNums,mice:my_widget_script.mice};return JSON.stringify(output)},from_json:function(json_data){
var parsedJson=JSON.parse(json_data);this.parent_class.from_json(JSON.stringify(parsedJson.widgetData))},test_data:function(){var testData=JSON.parse(this.parent_class.test_data()),output={widgetData:testData,mouseNums:[1,2,3,4,5,6,7],mice:{1:{id:"CRH-01",cycleNum:"1",startDate:"2021-04-01",
endDate:"2021-04-17"},2:{id:"CRH-02",cycleNum:"2",startDate:"2021-04-01",endDate:"2021-04-17"},3:{id:"CRH-03",cycleNum:"3",startDate:"2021-04-01",endDate:"2021-04-17"},4:{id:"CRH-04",cycleNum:"4",startDate:"2021-04-01",endDate:"2021-04-17"},5:{id:"CRH-05",cycleNum:"5",startDate:"2021-04-01",
endDate:"2021-04-17"},6:{id:"CRH-06",cycleNum:"6",startDate:"2021-04-01",endDate:"2021-04-17"},7:{id:"CRH-07",cycleNum:"7",startDate:"2021-04-01",endDate:"2021-04-17"}}};return JSON.stringify(output)},is_valid:function(b_suppress_message){var fail=false,fail_log="",name
;if($("#the_form").find("select, textarea, input").each((i,e)=>{if(!$(e).prop("required"));else if(!$(e).val())fail=true,name=$(e).attr("id"),fail_log+=name+" is required \n"}),$("input[type='date']").each((i,e)=>{var date=$(e).val();if(date){var validDate=this.isValidDate(date)
;if(!validDate)fail=true,fail_log+="Please enter valid date in form 'YYYY-MM-DD'"}}),$("input[type='time']").each((i,e)=>{var time=$(e).val();if(time){var validtime=this.isValidTime(time);if(!validtime)fail=true,fail_log+="Please enter valid time in form 'hh:mm' - 24 hr time"}}),
fail)return bootbox.alert (fail_log);else{var noErrors=[];return noErrors}},is_edited:function(){return this.parent_class.is_edited()},reset_edited:function(){return this.parent_class.reset_edited()},myFunctions:function(){var $;$=jQuery,void($.fn.mySort=function(options){var settings=$.extend({
toSort:".sortCard",sortBy:"mouse"},options);return this.find(settings.toSort).sort(function(a,b){
if("date"==settings.sortBy)var aDate=luxon.DateTime.fromISO($(a).data(settings.sortBy)),bDate=luxon.DateTime.fromISO($(b).data(settings.sortBy)),diff=aDate.diff(bDate,"days").as("days");else var diff=$(a).data(settings.sortBy)-$(b).data(settings.sortBy);return diff}).appendTo(this),this})},
parseInitJson:function(json_data){var jsonString;if("string"===typeof json_data)jsonString=json_data;else jsonString=json_data();var parsedJson=JSON.parse(jsonString);return parsedJson},initDynamicContent:function(parsedJson){
if(parsedJson.mice)my_widget_script.mice=parsedJson.mice;else my_widget_script.mice={};if(parsedJson.mouseNums){for(var i=0;i<parsedJson.mouseNums.length;i++)mouse=parsedJson.mouseNums[i],my_widget_script.mouseNums.push(mouse),my_widget_script.makeMouseCard(mouse),
my_widget_script.adjustScoringRows(mouse,false);for(date in this.dates){today=luxon.DateTime.now().toISODate();var isToday=false;if(date==today)isToday=true;header="Date: "+date;var cardBody=document.createDocumentFragment();cardBody.appendChild(my_widget_script.createLabelRow())
;for(var dateSearch=my_widget_script.dateSearch(date),x=document.querySelectorAll(".sortCard"+dateSearch),j=0;j<x.length;j++)cardBody.appendChild(x[j]);my_widget_script.makeCard($(".madeCards"),header,cardBody);var $cardBody=$(".madeCards").find(".card-body").last();for(mouse in this.dates[date]){
var day=this.dates[date][mouse];this.makeScoringRow(mouse,date,day,$cardBody)}if(isToday)$(".madeCards").find(".card-header").last().addClass("cardToday")}}else my_widget_script.mouseNums=[]},adjustForMode:function(mode){if("edit"!==mode&&"edit_dev"!==mode)$(".disableOnView").prop("disabled",true),
$("input[type='date']").removeClass(".hasDatePicker"),$(".hideView").hide(),$("#copyDiv").insertBefore("#addMouseDiv"),$(".tableOuterDiv").insertAfter("#copyDiv"),$(".editOnView").prop("readonly","").prop("disabled",""),
$(".editOnView").find("option").prop("disabled","");else $("input[type='date']").each((i,e)=>{this.checkDateFormat($(e))}),$("input[type='time']").each((i,e)=>{this.checkTimeFormat($(e))}),this.toggleCard($(".cardToday"))},addEventListeners:function(){$(".toggleSpec").on("click",e=>{
if($(e.currentTarget).hasClass("hidden"))$(e.currentTarget).val("Show only scoring"),$(e.currentTarget).removeClass("hidden");else $(e.currentTarget).val("Show all"),$(e.currentTarget).addClass("hidden");this.toggleSpecs()}),$(".sortButton").on("click",e=>{var sortBy=$(e.currentTarget).data("sort")
;this.sortFunc(sortBy),$(".watch").each((i,e)=>{this.watchValue($(e))})}),$("#addMouse").on("click",e=>{if(this.mouseNums.length>0)var lastMouse=this.mouseNums[this.mouseNums.length-1],mouseNum=lastMouse+1;else var mouseNum=1;var inArray=this.checkInArray(mouseNum,this.mouseNums)
;if(!inArray)this.mouseNums.push(mouseNum),this.mice[mouseNum]={},this.makeMouseCard(mouseNum),this.makeTableCols(),this.sortFunc("date")}),$("#makeCharts").on("click",e=>{this.makeCharts()})},addRequiredFieldIndicators:function(){$(".needForTableLab").each((i,e)=>{
$(e).html("<span class='hideView' style='color:blue'>#</span>"+$(e).html())}),$(".requiredLab").each((i,e)=>{$(e).html("<span class='hideView' style='color:red'>*</span>"+$(e).html())})},isValidTime:function(timeString){var regEx="^(((([0-1][0-9])|(2[0-3])):[0-5][0-9]))$"
;if(!timeString.match(regEx))return false;else return true},isTimeSupported:function(){var input=document.createElement("input");input.setAttribute("type","time");var supported=true;if("time"!==input.type)supported=false;return this.timeSupported=supported,input.remove(),supported},
timeSupported:true,checkTimeFormat:function($timeInput){if(!this.timeSupported){$timeInput.next(".timeWarning").remove();var time=$timeInput.val(),isValid=this.isValidTime(time);if(!isValid)$timeInput.after('<div class="text-danger timeWarning">Enter time as "hh:mm" in 24-hr format</div>')
;this.resize()}},isValidDate:function(dateString){var regEx=/^\d{4}-\d{2}-\d{2}$/;if(!dateString.match(regEx))return false;var d=new Date(dateString),dNum=d.getTime();if(!dNum&&0!==dNum)return false;return d.toISOString().slice(0,10)===dateString},isDateSupported:function(){
var input=document.createElement("input");input.setAttribute("type","date");var supported=true;if("date"!==input.type)supported=false;return this.dateSupported=supported,input.remove(),supported},dateSupported:true,checkDateFormat:function($dateInput){if(!this.dateSupported){
$dateInput.next(".dateWarning").remove();var date=$dateInput.val(),isValid=this.isValidDate(date);if(!isValid)$dateInput.after('<div class="text-danger dateWarning">Enter date as "YYYY-MM-DD"</div>');$dateInput.datepicker({dateFormat:"yy-mm-dd"}),this.resize()}},setUpInitialState:function(){
$(".myLeftCol").addClass("col-12 col-sm-6 col-md-4 col-lg-3 text-left text-sm-right"),this.isDateSupported(),this.isTimeSupported(),$("input[type='date']").prop("placeholder","YYYY-MM-DD").on("change",e=>{this.checkDateFormat($(e.currentTarget))}),
$("input[type='time']").prop("placeholder","hh:mm").on("change",e=>{this.checkTimeFormat($(e.target))}),$("textarea.autoAdjust").each((i,e)=>{e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")}).on("input",e=>{e.target.style.height="auto",
e.target.style.height=e.target.scrollHeight+"px",this.resize()}),$(".toggleTable").on("click",e=>{var tableID=$(e.currentTarget).data("table"),$table=$("#"+tableID),$errorMsg=$("#errorMsg");this.toggleTableFuncs($table,$errorMsg)}),$(".toCSV").on("click",e=>{
var tableID=$(e.currentTarget).data("table"),dateToday=luxon.DateTime.now().toISODate(),fileName="cycling_"+dateToday,$errorMsg=$("#errorMsg");this.toCSVFuncs(fileName,tableID,$errorMsg)}),$(".copyData").on("click",e=>{
var tableID=$(e.currentTarget).data("table"),copyType=$(e.currentTarget).data("copy"),tableSearch=this.tableSearch(tableID),$tableToCopy=$("#"+tableID),$tableDiv=$tableToCopy.parent(),$errorMsg=$("#errorMsg"),$divForCopy=$("#forCopy"),startDay,endDay,copyHead,transpose,numAddedCols=$tableToCopy.find("thead").find(".added").length
;if("simple"===copyType)copyHead=false,transpose=false,startDay=1,endDay=numAddedCols;else{if(startDay=$("#startDayCopy").val(),endDay=$("#endDayCopy").val(),!startDay||startDay<1)startDay=1;if(!endDay||endDay>numAddedCols)endDay=numAddedCols;copyHead=$(e.currentTarget).data("head"),
transpose=$(e.currentTarget).data("transpose")}this.copyDataFuncs(copyHead,$tableToCopy,$tableDiv,$errorMsg,$divForCopy,transpose,startDay,endDay)}),$("#the_form").on("input",e=>{if($(e.target).data("watch"))this.watchValue($(e.target));else this.updateCalcFromEl(e.target)}),
$("input, select, textarea").each((i,e)=>{if("button"!=$(e).attr("type"))if($(e).data("watch"))this.watchValue($(e));else this.updateCalcFromEl(e)}),this.makeTableCols(),$(".mouseHeader").each((i,e)=>{this.toggleCard($(e))}),this.resize()},mouseNums:[],mice:{},dates:{},resize:function(){
this.parent_class.resize_container()},checkForNames:function(){$("input, select, textarea").each((i,e)=>{var thisName=$(e).attr("name");if(!thisName)console.log("There is no name attribute for: ",e.id);else{var hasUpper=/[A-Z]/.test(thisName)
;if(hasUpper)console.log("The name contains an uppercase letter for: ",e.id)}})},getDynamicContent:function(){var dynamicContent={};return dynamicContent},toggleSpecs:function(){if($(".toggleSpec").hasClass("hidden"))$(".showCol[data-col='total']").hide(),$(".showCol[data-col='nuc']").hide(),
$(".showCol[data-col='corn']").hide(),$(".showCol[data-col='leuko']").hide();else $(".showCol[data-col='total']").show(),$(".showCol[data-col='nuc']").show(),$(".showCol[data-col='corn']").show(),$(".showCol[data-col='leuko']").show()},sortFunc:function(sortBy){console.log("running sort func"),
$(".cardContainer").mySort({sortBy:sortBy});var sortVals=[];if($(".sortCard").each((i,e)=>{var sortVal=$(e).data(sortBy);if(!this.checkInArray(sortVal,sortVals))sortVals.push(sortVal)}),$(".madeCards").html(""),sortVals)for(var i=0;i<sortVals.length;i++){var sortVal=sortVals[i]
;if("mouse"==sortBy)header="<div data-calc='mouse' data-mouse='"+sortVal+"'>"+this.capitalize(sortBy)+": "+sortVal+"</div>";else header=this.capitalize(sortBy)+": "+sortVal;var cardBody=document.createDocumentFragment();cardBody.appendChild(this.createLabelRow())
;for(var dataSearch=this.dataSearch(sortBy,sortVal),x=document.querySelectorAll(".sortCard"+dataSearch),j=0;j<x.length;j++)cardBody.appendChild(x[j]);this.makeCard($(".madeCards"),header,cardBody);var $cardBody=$(".madeCards").find(".card-body").last();$cardBody.mySort({sortBy:"day"}),
$cardBody.mySort({sortBy:"mouse"})}var colSearch=this.colSearch(sortBy);$(".sortCol"+colSearch).hide(),$(".sortCol").not(colSearch).show(),this.toggleSpecs(),this.resize()},data_valid_form:function($errorMsg){var valid=true,fail_log=$("<div></div>").append("Missing values for:"),name
;if($(".needForTable").each((i,e)=>{if(!$(e).val())valid=false,name=$(e).attr("id"),fail_log.append("<br/>"+name)}),!valid)$errorMsg.html("<span style='color:red; font-size:36px;'>"+"Please fill out all elements marked by a"+"</span><span style='color:blue; font-size:36px;'>"+" blue #"+"</span>"),
$errorMsg.append(fail_log);else $errorMsg.html("");return this.resize(),valid},getOffsetTop:function(element){var offsetTop=0,lastElement=0;while(element&&!lastElement){var formChild=$(element).children("#the_form");if(formChild.length>0)lastElement=1;offsetTop+=element.offsetTop,
element=element.offsetParent}return offsetTop},runIfConfirmed:function(text,functionToCall,elForHeight=null){var thisMessage="Are you sure?";if(text)thisMessage=text;var top="auto";if(elForHeight)top=this.getOffsetTop(elForHeight)+"px";bootbox.confirm ({message:thisMessage,callback:proceed=>{
if(proceed)functionToCall()}}),$(".modal-dialog").css("top",top)},dialogConfirmx:function(text,functionToCall,elForHeight=null){var thisMessage="Do you want to proceed?";if(text)thisMessage=text;var top="auto";if(elForHeight)top=this.getOffsetTop(elForHeight)+"px";bootbox.confirm ({
message:thisMessage,callback:result=>{functionToCall(result)}}),$(".modal-dialog").css("top",top)},runBasedOnInput:function(prompt,functionToCall,elForHeight=null){var thisTitle="Enter value:";if(prompt)thisTitle=prompt;var top="auto";if(elForHeight)top=this.getOffsetTop(elForHeight)+"px"
;bootbox.prompt({title:thisTitle,callback:result=>{functionToCall(result)}}),$(".modal-dialog").css("top",top)},checkInArray:function(searchVal,array){var proceed=-1!==$.inArray(searchVal,array);return proceed},dataSearch:function(dataName,dataValue){
var dataSearch="[data-"+dataName+"='"+dataValue+"']";return dataSearch},tableSearch:function(table){var tableSearch=this.dataSearch("table",table);return tableSearch},calcSearch:function(calc){var calcSearch=this.dataSearch("calc",calc);return calcSearch},daySearch:function(day){
var daySearch=this.dataSearch("day",day);return daySearch},colSearch:function(colVal){var colSearch=this.dataSearch("col",colVal);return colSearch},dateSearch:function(date){var dateSearch=this.dataSearch("date",date);return dateSearch},mouseSearch:function(mouse){
var mouseSearch=this.dataSearch("mouse",mouse);return mouseSearch},capitalize:function(string){return string.charAt(0).toUpperCase()+string.slice(1)},updateCalcFromEl:function(el){var calc=el.id,val=el.value,calcSearch=this.calcSearch(calc);$(calcSearch).html(val),this.resize()},
updateCalcFromVal:function(calc,val){var calcSearch=this.calcSearch(calc);$(calcSearch).text(val),this.resize()},watchValue:function($el){var watch=$el.data("watch"),calcSearch=this.calcSearch(watch),dayNum=$el.data("day"),mouseNum=$el.data("mouse"),val=$el.val()
;if(dayNum)calcSearch+=this.daySearch(dayNum);if(mouseNum)calcSearch+=this.mouseSearch(mouseNum);if("mouse"==watch)if(!val)val="Mouse "+mouseNum;$(calcSearch).html(val),this.resize()},toggleTableFuncs:function($table,$errorMsg){this.data_valid_form($errorMsg),$table.toggle(),this.resize()},
toCSVFuncs:function(fileName,tableID,$errorMsg){var data_valid=this.data_valid_form($errorMsg);if(data_valid)this.exportTableToCSV(fileName,tableID),
$errorMsg.html("<span style='color:grey; font-size:24px;'>Saved successfully</span>");else $errorMsg.append("<br/><span style='color:grey; font-size:24px;'>Did not export</span>")},downloadCSV:function(csv,filename){var csvFile,downloadLink;csvFile=new Blob([csv],{type:"text/csv"}),
downloadLink=document.createElement("a"),downloadLink.download=filename,downloadLink.href=window.URL.createObjectURL(csvFile),downloadLink.style.display="none",document.body.appendChild(downloadLink),downloadLink.click()},exportTableToCSV:function(filename,table){
var tableArray=this.getTableArray($("#"+table),copyHead=true,transpose=false),tableString=this.convertRowArrayToString(tableArray,",","\n");this.downloadCSV(tableString,filename)},copyDataFuncs:function(copyHead,$tableToCopy,$tableDiv,$errorMsg,$divForCopy,transpose,start,end){
var data_valid=this.data_valid_form($errorMsg);if(data_valid)$tableDiv.show(),this.resize(),this.copyTable($tableToCopy,copyHead,$divForCopy,$errorMsg,transpose,start,end),
$errorMsg.html("<span style='color:grey; font-size:24px;'>Copied successfully</span>");else $errorMsg.append("<br/><span style='color:grey; font-size:24px;'>Nothing was copied</span>"),this.resize()},copyTable:function($table,copyHead,$divForCopy,$errorMsg,transpose,start,end){
var tableArray=this.getTableArray($table,copyHead,transpose,start,end),tableString=this.convertRowArrayToString(tableArray,"\t","\n");this.copyStringToClipboard(tableString,$divForCopy,$errorMsg)},getTableArray:function($table,copyHead,transpose,start,end){var rows=[],rowNum=0
;if(copyHead)$table.find("thead").children("tr").each((i,e)=>{if(transpose)rowNum=0;if($(e).find("td, th").each((i,e)=>{var day=$(e).data("day");if($(e).is(".mouse, .cycleNum, .startDate")||day>=start&&day<=end){if(void 0===rows[rowNum])rows[rowNum]=[];if(rows[rowNum].push($(e).text()),
transpose)rowNum++}}),!transpose)rowNum++});return $table.find("tbody").children("tr").each((i,e)=>{if(transpose)rowNum=0;if($(e).find("td, th").each((i,e)=>{var day=$(e).data("day");if($(e).is(".mouse, .cycleNum, .startDate")||day>=start&&day<=end){if(void 0===rows[rowNum])rows[rowNum]=[]
;if(rows[rowNum].push($(e).text()),transpose)rowNum++}}),!transpose)rowNum++}),rows},convertRowArrayToString:function(rowArray,cellSepString="\t",newRowString="\n"){var rowString=[];rowArray.forEach(row=>{if(row.length)row.forEach((cell,i)=>{
if(cell.includes(cellSepString)||cell.includes(newRowString))row[i]='"'+cell+'"'}),rowString.push(row.join(cellSepString))});var tableString=rowString.join(newRowString);return tableString},copyStringToClipboard:function(textStr,$divForCopy,$errorMsg){
var $temp=$("<text"+"area style='opacity:0;'></text"+"area>");if(textStr)errorStr="Copy attempted",$errorMsg.html("<span style='color:grey; font-size:24px;'>Copy attempted</span>");else textStr=" ",$errorMsg.html("<span style='color:red; font-size:24px;'>Nothing to copy</span>");$temp.text(textStr),
console.log(textStr),$temp.appendTo($divForCopy).select(),document.execCommand("copy"),$temp.remove(),this.resize()},toggleCard:function($cardHead){$cardHead.next().toggleClass("collapse"),$cardHead.next().find("textarea.autoAdjust").each((i,e)=>{
if(!$(e).is(":hidden"))e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")}),this.resize()},makeCard:function($div,cardHeadContent,cardBodyContent){$div.append($("<div></div>",{class:"card"}).append($("<button></button>",{type:"button",class:"card-header"}).on("click",e=>{
this.toggleCard($(e.currentTarget))}).append(cardHeadContent)).append($("<div></div>",{class:"card-body collapse"}).append(cardBodyContent))),this.resize()},makeScoringRow:function(mouseNum,dateString,day,$appendContainer){var $cardContainer=$("<div/>",{class:"card sortCard","data-mouse":mouseNum,
"data-day":day,"data-date":dateString});labelClasses="col-12 font-weight-bold",dataCols=["mouse","date","day","total","nuc","corn","leuko","stage","final"],extraClasses=["sortCol","sortCol","sortCol","showCol","showCol","showCol","showCol","showCol","showCol"],sortClasses="col-12 col-md sortCol",
showClasses="col-12 col-md showCol",inputCols=["total","nuc","corn","leuko","stage"],$cardContainer.append($("<div/>",{class:"row"}).append($("<div/>",{class:"col-6 d-md-none row labelRow","data-mouse":mouseNum})).append($("<div/>",{class:"col-6 col-md-12 row mouseRow","data-mouse":mouseNum
}).append($("<div/>",{class:sortClasses,"data-col":"mouse","data-calc":"mouse","data-mouse":mouseNum}).css("word-break","break-all").append("Mouse "+mouseNum)).append($("<div/>",{class:sortClasses,"data-col":"date"}).append(dateString)).append($("<div/>",{class:sortClasses,"data-col":"day"
}).append(day))));for(var i=0;i<dataCols.length;i++){var col=dataCols[i],extraClass=extraClasses[i];$cardContainer.find(".labelRow[data-mouse='"+mouseNum+"']").append($("<div/>",{class:labelClasses+" "+extraClass,"data-col":col}).append(this.capitalize(col)))}for(var i=0;i<inputCols.length;i++){
var col=inputCols[i];$cardContainer.find(".mouseRow[data-mouse='"+mouseNum+"']").append($("<div/>",{class:showClasses,"data-col":col}).append($("<input/>",{class:"fullWidth watch "+col,name:col+mouseNum+"_"+day,id:col+mouseNum+"_"+day,"data-mouse":mouseNum,"data-day":day,"data-date":dateString,
"data-watch":col})))}$cardContainer.find(".mouseRow[data-mouse='"+mouseNum+"']").append($("<div/>",{class:showClasses,"data-col":"final"}).append($("<select/>",{class:"fullWidth final watch",name:"final"+mouseNum+"_"+day,id:"final"+mouseNum+"_"+day,"data-mouse":mouseNum,"data-day":day,
"data-date":dateString,"data-watch":"final"}).append('<option value="">[Select]</option><option value="1">Estrus</option><option value="2">Diestrus</option><option value="3">Proestrus</option>'))),$appendContainer.append($cardContainer),$cardContainer.find(".watch").on("input",e=>{
this.watchValue($(e.currentTarget))})},createLabelRow:function(){labelClasses="col font-weight-bold",dataCols=["mouse","date","day","total","nuc","corn","leuko","stage","final"],extraClasses=["sortCol","sortCol","sortCol","showCol","showCol","showCol","showCol","showCol","showCol"]
;var card=document.createElement("div");card.className="card d-none d-md-flex topTableRow";var row=document.createElement("div");row.className="row";var col=document.createElement("div");col.className="col-12 row labelRow";for(var i=0;i<dataCols.length;i++){
var colName=dataCols[i],extraClass=extraClasses[i],e=document.createElement("div");e.className=labelClasses+" "+extraClass,e.dataset.col=colName,content=document.createTextNode(this.capitalize(colName)),e.appendChild(content),col.appendChild(e)}return row.appendChild(col),card.appendChild(row),card
},appendLabelRow:function($div){labelClasses="col font-weight-bold",dataCols=["mouse","date","day","total","nuc","corn","leuko","stage","final"],extraClasses=["sortCol","sortCol","sortCol","showCol","showCol","showCol","showCol","showCol","showCol"],$div.append($("<div></div>",{
class:"card d-none d-md-flex topLabelRow"}).append($("<div/>",{class:"row"}).append($("<div/>",{class:"col-12 row labelRow"}))));for(var i=0;i<dataCols.length;i++){var col=dataCols[i],extraClass=extraClasses[i];$div.find(".labelRow").last().append($("<div></div>",{class:labelClasses+" "+extraClass,
"data-col":col}).append(this.capitalize(col)))}},startDateFuncs:function($el,mouseNum){this.checkDateFormat($el);var currentDate=this.mice[mouseNum]["startDate"],thisDate=$el.val();if(currentDate&&currentDate!=thisDate)$el.val(currentDate),
this.runIfConfirmed("This will reset all sampling days for this mouse. Are you sure you want to proceed?",()=>{this.runIfConfirmed("All data you've entered for this mouse will be erased. Are you sure you want to proceed?",()=>{for(var date in this.mice[mouseNum]["dates"]=[],this.dates){
var inDates=this.dates[date].hasOwnProperty(mouseNum);if(inDates){delete this.dates[date][mouseNum];var mouseSearch=this.mouseSearch(mouseNum),dateSearch=this.dateSearch(date);$(mouseSearch+dateSearch).remove()}}this.mice[mouseNum]["startDate"]=thisDate,$el.val(thisDate),
this.adjustScoringRows(mouseNum,true),this.sortFunc("date"),this.makeTableCols()},elForHeight=$el.get(0))},elForHeight=$el.get(0));else this.mice[mouseNum]["startDate"]=thisDate,this.adjustScoringRows(mouseNum,true),this.sortFunc("date"),this.makeTableCols()},endDateFuncs:function($el,mouseNum){
this.checkDateFormat($el);var currentDate=this.mice[mouseNum]["endDate"],thisDate=$el.val(),currentAsDate=luxon.DateTime.fromISO(currentDate).startOf("day"),thisAsDate=luxon.DateTime.fromISO(thisDate).startOf("day");if(currentDate&&currentAsDate>thisAsDate)$el.val(currentDate),
this.runIfConfirmed("This will remove sampling days. Are you sure you wish to proceed?",()=>{this.mice[mouseNum]["endDate"]=thisDate,$el.val(thisDate),this.adjustScoringRows(mouseNum,true),this.sortFunc("date"),this.makeTableCols()
},elForHeight=$el.get(0));else this.mice[mouseNum]["endDate"]=$el.val(),this.adjustScoringRows(mouseNum,true),this.sortFunc("date"),this.makeTableCols()},makeMouseCard:function(mouseNum){var $div=$(".mouseInfo");if(!$div.find(".card").length)$div.html("");var row="row mt-2",col="col-12 col-lg-6"
;$div.append($("<div/>",{class:"col col-md-6 mt-2 mouseCard","data-mouse":mouseNum}).append($("<div/>",{class:"card"}).append($("<button></button>",{class:"card-header mouseHeader",type:"button","data-calc":"mouse","data-mouse":mouseNum}).on("click",e=>{this.toggleCard($(e.currentTarget))
}).append("Mouse "+mouseNum)).append($("<div/>",{class:"card-body"}).append($("<div/>",{class:row}).append($("<div/>",{class:col}).append("<h4>Mouse ID:</h4>")).append($("<div/>",{class:"col"}).append($("<input/>",{type:"text","data-mouse":mouseNum,id:"mouseID"+mouseNum,name:"mouseid"+mouseNum,
class:"mouseID fullWidth watch","data-watch":"mouse"}).on("change",e=>{this.mice[mouseNum]["id"]=$(e.currentTarget).val()})))).append($("<div/>",{class:row}).append($("<div/>",{class:col}).append("<h5>Cycle ID #:</h5>")).append($("<div/>",{class:"col"}).append($("<input/>",{type:"number",
"data-mouse":mouseNum,id:"cycleNum"+mouseNum,name:"cyclenum"+mouseNum,class:"cycleNum fullWidth watch","data-watch":"cycleNum"}).on("change",e=>{this.mice[mouseNum]["cycleNum"]=$(e.currentTarget).val()})))).append($("<div/>",{class:row+" hideView"}).append($("<div/>",{class:col
}).append("Delete:")).append($("<div/>",{class:"col"}).append($("<input/>",{type:"button",value:"Delete Mouse","data-mouse":mouseNum,id:"deleteMouse"+mouseNum,name:"deletemouse"+mouseNum,class:"deleteMouse fullWidth"}).on("click",e=>{
this.deleteMouseFuncs($(e.currentTarget).data("mouse"),elForHeight=e.currentTarget)})))).append($("<div/>",{class:row}).append($("<div/>",{class:col}).append("Start Date:")).append($("<div/>",{class:"col"}).append($("<input/>",{type:"date","data-mouse":mouseNum,id:"startDate"+mouseNum,
name:"startdate"+mouseNum,class:"startDate fullWidth watch","data-watch":"startDate"}).each((i,e)=>{this.checkDateFormat($(e))}).on("change",e=>{this.startDateFuncs($(e.currentTarget),mouseNum)}).on("keypress",e=>{if($(e.currentTarget).off("change blur"),$(e.currentTarget).on("blur",e=>{
if(this.isValidDate($(e.currentTarget).val()))this.startDateFuncs($(e.currentTarget),mouseNum);$(e.currentTarget).off("blur"),$(e.currentTarget).on("change",e=>{this.startDateFuncs($(e.currentTarget),mouseNum)})}),
13===event.keyCode)if(this.isValidDate($(e.currentTarget).val()))this.startDateFuncs($(e.currentTarget),mouseNum)})))).append($("<div/>",{class:row}).append($("<div/>",{class:col}).append("End Date:")).append($("<div/>",{class:"col"}).append($("<input/>",{type:"date","data-mouse":mouseNum,
id:"endDate"+mouseNum,name:"enddate"+mouseNum,class:"endDate fullWidth watch","data-watch":"endDate"}).each((i,e)=>{this.checkDateFormat($(e))}).on("change",e=>{this.endDateFuncs($(e.currentTarget),mouseNum)}).on("keypress",e=>{if($(e.currentTarget).off("change blur"),
$(e.currentTarget).on("blur",e=>{if(this.isValidDate($(e.currentTarget).val()))this.endDateFuncs($(e.currentTarget),mouseNum);$(e.currentTarget).off("blur"),$(e.currentTarget).on("change",e=>{this.endDateFuncs($(e.currentTarget),mouseNum)})}),
13===event.keyCode)if(this.isValidDate($(e.currentTarget).val()))this.endDateFuncs($(e.currentTarget),mouseNum)})))))));var $mouseTable=$("#mouseTable");$mouseTable.find("tbody").append($("<tr/>",{"data-mouse":mouseNum}).append($("<td/>",{"data-calc":"mouse","data-mouse":mouseNum,class:"mouse"
}).append("Mouse "+mouseNum)).append($("<td/>",{"data-calc":"cycleNum","data-mouse":mouseNum,class:"cycleNum"})).append($("<td/>",{"data-calc":"startDate","data-mouse":mouseNum,class:"startDate"}))),$(".watch").on("input",e=>{this.watchValue($(e.currentTarget))}),this.resize()},
deleteMouseFuncs:function(mouseNum,elForHeight=null){this.runIfConfirmed("Are you sure that you wish to delete this mouse?",()=>{var index=this.mouseNums.indexOf(mouseNum);if(index>-1)this.mouseNums.splice(index,1);for(date in delete this.mice[mouseNum],this.dates)delete this.dates[date][mouse]
;var mouseSearch=this.mouseSearch(mouseNum);$(mouseSearch).remove(),this.sortFunc("date")},elForHeight=elForHeight),this.resize()},adjustScoringRows:function(mouse,makeRow){var mouseInfo=this.mice[mouse],startDate=mouseInfo.startDate,endDate=mouseInfo.endDate,numDays=0;if(startDate&&endDate){
var startDateAsDate=luxon.DateTime.fromISO(startDate).startOf("day"),endDateAsDate=luxon.DateTime.fromISO(endDate).startOf("day");numDays=endDateAsDate.diff(startDateAsDate,"days").as("days")+1}if(this.mice[mouse]["numDays"]=numDays,this.mice[mouse]["dates"]=[],
numDays>0)for(var date=startDateAsDate,j=0;j<numDays;j++){var dateString=date.toISODate(),day=j+1,dateOb=this.dates[dateString];if(!dateOb)this.dates[dateString]={};var inDateOb=this.dates[dateString].hasOwnProperty(mouse);if(!inDateOb)if(this.dates[dateString][mouse]=day,
makeRow)this.makeScoringRow(mouse,dateString,day,$(".cardContainer"));var inMouseDateOb=this.checkInArray(dateString,this.mice[mouse]["dates"]);if(!inMouseDateOb)this.mice[mouse]["dates"].push(dateString);date=date.plus({days:1})}for(var date in this.dates){
var inMouseDate=this.checkInArray(date,this.mice[mouse]["dates"]);if(!inMouseDate){var inDates=this.dates[date].hasOwnProperty(mouse);if(inDates){delete this.dates[date][mouse];var mouseSearch=this.mouseSearch(mouse),dateSearch=this.dateSearch(date);$(mouseSearch+dateSearch).remove()}}}},
maxNumDays:0,makeTableCols:function(){var $table=$("#mouseTable");for(var mouse in newMax=0,this.mice){var numDays=this.mice[mouse]["numDays"];if(numDays>newMax)newMax=numDays}if(newMax>this.maxNumDays)for(var i=this.maxNumDays;i<newMax;i++){var day=i+1;$table.find("thead tr").append($("<th/>",{
class:"added","data-day":day}).append("Day"+day))}else if(this.maxNumDays>newMax)for(var i=newMax;i<this.maxNumDays;i++){var day=i+1,daySearch=this.daySearch(day);$table.find("thead tr").find("th"+daySearch).remove()}for(var mouse in this.maxNumDays=newMax,this.mice){
var mouseSearch=this.mouseSearch(mouse),$row=$table.find("tr"+mouseSearch),days=[];$row.find("td").each(function(){days.push($(this).data("day"))});for(var i=0;i<newMax;i++){var day=i+1;if(!this.checkInArray(day,days))$row.append($("<td/>",{class:"added","data-calc":"final","data-day":day,
"data-mouse":mouse}));else{var index=days.indexOf(day);if(index>-1)days.splice(index,1)}}if(days)for(var i=0;i<days.length;i++){var day=days[i],daySearch=this.daySearch(day);$row.find("td"+daySearch).remove()}}$(".watch").each((i,e)=>{this.watchValue($(e))}),this.resize()},makeCharts:function(){
$("#chartDiv").html(""),$("#mouseTable tbody tr").each((i,e)=>{var mouseNum=e.dataset.mouse,id=this.mice[mouseNum].id;if(!id)id="Mouse "+mouseNum;var cycleNum=this.mice[mouseNum].cycleNum;if(cycleNum)id=id+"-"+cycleNum;var rowArray=[],day=1;$(e).find(".added").each((i,e)=>{var stage=$(e).text()
;if(stage)stage=parseInt(stage);else stage=NaN;rowArray.push([day,stage]),day++}),this.GoogleChart(rowArray,id,mouseNum)}),this.resize()},GoogleChart:function(rowArray,mouseID,mouseNum){function drawBasic(){var data=new google.visualization.DataTable;data.addColumn("number","Day"),
data.addColumn("number","Stage"),data.addRows(rowArray);var options={title:mouseID,hAxis:{title:"Day",gridlines:{color:"none",multiple:1}},vAxis:{title:"Stage",ticks:[{v:1,f:"E"},{v:2,f:"D"},{v:3,f:"P"}],minValue:0,maxValue:4,gridlines:{color:"none"}},legend:"none"}
;$("#chartDiv").append($("<div></div>",{id:"chartDiv"+mouseNum,style:"height: 200px"}));var chart=new google.visualization.LineChart(document.getElementById("chartDiv"+mouseNum));chart.draw(data,options),my_widget_script.resize()}google.charts.load("current",{packages:["corechart","line"],
callback:drawBasic})}};