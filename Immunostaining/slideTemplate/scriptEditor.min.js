my_widget_script={slideDivNums:[],slideNums:[],
init:function(mode,json_data){
var parsedJson=this.parseInitJson(json_data)
;window.onresize=this.resize,this.initDynamicContent(parsedJson),
this.parent_class.init(mode,()=>JSON.stringify(parsedJson.widgetData)),
this.fillRowsColsOrientation(parsedJson),
this.addRequiredFieldIndicators(),this.setUpInitialState(),
this.adjustForMode(mode)},to_json:function(){
var widgetJsonString=this.parent_class.to_json(),dynamicContent=this.getDynamicContent(),output={
widgetData:JSON.parse(widgetJsonString),
slideDivNums:dynamicContent.slideDivNums,
slideNums:dynamicContent.slideNums,
slideInfo:dynamicContent.slideInfo,
selectedMice:dynamicContent.selectedMice}
;return JSON.stringify(output)},
from_json:function(json_data){
var parsedJson=JSON.parse(json_data)
;this.parent_class.from_json(JSON.stringify(parsedJson.widgetData))
},test_data:function(){
var testData=JSON.parse(this.parent_class.test_data()),output={
widgetData:testData,slideDivNums:[1,2],
slideNums:[1],slideInfo:{1:{cols:2,rows:2,
orientation:"row",cellInfo:{1:{text:"Cell 1",
filled:true},2:{text:"Cell 2",filled:true},3:{
text:"Cell 3",filled:false},4:{text:"Cell 4",
filled:false}}}}};return JSON.stringify(output)},
is_valid:function(b_suppress_message){
var fail=false,fail_log="",name
;if($("#the_form").find("select, textarea, input").each(function(){
if(!$(this).prop("required"));else if(!$(this).val())fail=true,
name=$(this).attr("id"),
fail_log+=name+" is required \n"
}),$("input[type='date']").each(function(){
var date=$(this).val();if(date){
var validDate=my_widget_script.isValidDate(date)
;if(!validDate)fail=true,fail_log+="Please enter valid date in form 'YYYY-MM-DD'"
}}),$("input[type='time']").each(function(){
var time=$(this).val();if(time){
var validtime=my_widget_script.isValidTime(time)
;if(!validtime)fail=true,fail_log+="Please enter valid time in form 'hh:mm' - 24 hr time"
}}),fail)return alert(fail_log);else{
var noErrors=[];return noErrors}},
is_edited:function(){
return this.parent_class.is_edited()},
reset_edited:function(){
return this.parent_class.reset_edited()},
parseInitJson:function(json_data){var jsonString
;if("string"===typeof json_data)jsonString=json_data;else jsonString=json_data()
;var parsedJson=JSON.parse(jsonString)
;return parsedJson},
initDynamicContent:function(parsedJson){
if(parsedJson.slideDivNums){
var numDivs=parsedJson.slideDivNums.length
;if(my_widget_script.makeSlideDiv(numDivs),
parsedJson.slideNums)for(var i=0;i<parsedJson.slideNums.length;i++){
var slide=parsedJson.slideNums[i],slideInfo=parsedJson.slideInfo[slide],cols=slideInfo.cols,rows=slideInfo.rows,orientation=slideInfo.orientation
;my_widget_script.slideNums.push(slide),
my_widget_script.buildForSlideDiv(slide,rows,cols,orientation)
;var slideSearch=my_widget_script.slideSearch(slide)
;$(".numRows"+slideSearch).val(rows),
$(".numCols"+slideSearch).val(cols),$(".orientation"+slideSearch).val(orientation)
;for(var numCells=cols*rows,$div=$(".slideDiv"+my_widget_script.slideSearch(slide)),j=0;j<numCells;j++){
var cell=j+1,cellInfo=slideInfo.cellInfo[cell],text=cellInfo.text,filled=cellInfo.filled,cellSearch=my_widget_script.cellSearch(cell),$cell=$div.find(cellSearch)
;if($cell.text(text),
filled)$cell.addClass("filled")}}}},
fillRowsColsOrientation:function(parsedJson){
if(parsedJson.slideNums)for(var i=0;i<parsedJson.slideNums.length;i++){
var slide=parsedJson.slideNums[i],slideInfo=parsedJson.slideInfo[slide],cols=slideInfo.cols,rows=slideInfo.rows,orientation=slideInfo.orientation,slideSearch=my_widget_script.slideSearch(slide)
;$(".numRows"+slideSearch).val(rows),
$(".numCols"+slideSearch).val(cols),$(".orientation"+slideSearch).val(orientation)
}},adjustForMode:function(mode){
if("edit"!==mode&&"edit_dev"!==mode)$(".disableOnView").prop("disabled",true),
$(".hideView").hide(),$(".slideDiv").show()},
addRequiredFieldIndicators:function(){
$(".needForTableLab").each(function(){
$(this).html("<span style='color:blue'>#</span>"+$(this).html())
}),$(".requiredLab").each(function(){
$(this).html("<span style='color:red'>*</span>"+$(this).html())
})},isValidTime:function(timeString){
var regEx="^(((([0-1][0-9])|(2[0-3])):[0-5][0-9]))$"
;if(!timeString.match(regEx))return false;else return true
},isTimeSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","time")
;var supported=true
;if("time"!==input.type)supported=false
;return my_widget_script.timeSupported=supported,
supported},timeSupported:true,
checkTimeFormat:function($timeInput){
if(!my_widget_script.timeSupported){
$timeInput.next(".timeWarning").remove()
;var time=$timeInput.val(),isValid=my_widget_script.isValidTime(time)
;if(!isValid)$timeInput.after('<div class="text-danger timeWarning">Enter time as "hh:mm" in 24-hr format</div>')
}},isValidDate:function(dateString){
var regEx=/^\d{4}-\d{2}-\d{2}$/
;if(!dateString.match(regEx))return false
;var d=new Date(dateString),dNum=d.getTime()
;if(!dNum&&0!==dNum)return false
;return d.toISOString().slice(0,10)===dateString},
isDateSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","date")
;var supported=true
;if("date"!==input.type)supported=false
;return my_widget_script.dateSupported=supported,
supported},dateSupported:true,
checkDateFormat:function($dateInput){
if(!my_widget_script.dateSupported){
$dateInput.next(".dateWarning").remove()
;var date=$dateInput.val(),isValid=my_widget_script.isValidDate(date)
;if(!isValid)$dateInput.after('<div class="text-danger dateWarning">Enter date as "YYYY-MM-DD"</div>')
;$dateInput.datepicker({dateFormat:"yy-mm-dd"
}),console.log($dateInput.val())}},
setUpInitialState:function(){
my_widget_script.isDateSupported(),my_widget_script.isTimeSupported(),
$("input[type='date']").prop("placeholder","YYYY-MM-DD").on("change",function(){
my_widget_script.checkDateFormat($(this))
}).each(function(){
my_widget_script.checkDateFormat($(this))
}),$("input[type='time']").prop("placeholder","hh:mm").on("change",function(){
my_widget_script.checkTimeFormat($(this))
}).each(function(){
my_widget_script.checkTimeFormat($(this))
}),$(".myLeftCol").addClass("col-12 col-sm-6 col-md-4 col-lg-3 text-left text-sm-right"),
$("textarea.autoAdjust").each((i,e)=>{
if(!$(e).is(":hidden"))e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")
}).on("input",function(){
this.style.height="auto",this.style.height=this.scrollHeight+"px",
my_widget_script.resize()
}),$(".makeSlideDiv").on("click",function(){
var maxSlide=Math.max.apply(Math,my_widget_script.slideDivNums)
;if(maxSlide==-1/0)maxSlide=0;var slide=maxSlide+1
;console.log(maxSlide),my_widget_script.makeSlideDiv(slide)
}),$(".makeSlide").on("click",function(){
var slide=$(this).data("slide")
;my_widget_script.makeSlide(slide)
}),$("#selectSlide").each((i,e)=>{
var selectedSlide=$(e).val(),slideSearch=this.slideSearch(selectedSlide)
;$(".slideDiv"+slideSearch).show().find("textarea.autoAdjust").each((i,e)=>{
if(!$(e).is(":hidden"))e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")
}),
$(".slideDiv").not(slideSearch).hide(),this.resize()
}).on("input",e=>{
var selectedSlide=$(e.currentTarget).val(),slideSearch=this.slideSearch(selectedSlide)
;$(".slideDiv"+slideSearch).show().find("textarea.autoAdjust").each((i,e)=>{
if(!$(e).is(":hidden"))e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")
}),
$(".slideDiv").not(slideSearch).hide(),this.resize()
}),$("#fixVal").on("input",function(){
var fixedText=$(this).val()
;$(".fixing").text(fixedText)
}).on("focusout",function(){
$(".fixing").removeClass("fixing"),$(".forFixing").hide(),
my_widget_script.resize()
}),$(".watch").each((i,e)=>{this.watchValue($(e))
}).on("input",e=>{
this.watchValue($(e.currentTarget))
}),$(".forFixing").hide(),this.resize()},
resize:function(){
my_widget_script.parent_class.resize_container()},
getDynamicContent:function(){var slideInfo={}
;if(my_widget_script.slideNums)for(var i=0;i<my_widget_script.slideNums.length;i++){
var slide=my_widget_script.slideNums[i],slideSearch=my_widget_script.slideSearch(slide)
;$div=$(".forSlide"+slideSearch)
;for(var numCols=$div.data("numcols"),numRows=$div.data("numrows"),orientation=$div.data("orientation"),numMice=numCols*numRows,$div=$(".slideDiv"+my_widget_script.slideSearch(slide)),cellInfo={},j=0;j<numMice;j++){
var cell=j+1,cellSearch=my_widget_script.cellSearch(cell),$cell=$div.find(cellSearch),filled=$cell.hasClass("filled"),text=$cell.text()
;cellInfo[cell]={text:text,filled:filled}}
slideInfo[slide]={cellInfo:cellInfo,cols:numCols,
rows:numRows,orientation:orientation}}
var selectedMice=$("#idSelect").val(),dynamicContent={
slideDivNums:my_widget_script.slideDivNums,
slideNums:my_widget_script.slideNums,
slideInfo:slideInfo,selectedMice:selectedMice}
;return dynamicContent},
data_valid_form:function(){var valid=true
;if($(".needForTable").each(function(){
if(!$(this).val())valid=false
}),!valid)$("#errorMsg").html("<span style='color:red; font-size:36px;'>Please fill out all elements marked by a</span><span style='color:blue; font-size:36px;'> blue #</span>");else $("#errorMsg").html("")
;return valid},
dataSearch:function(dataName,dataValue){
var dataSearch="[data-"+dataName+"='"+dataValue+"']"
;return dataSearch},slideSearch:function(slide){
var slideSearch=my_widget_script.dataSearch("slide",slide)
;return slideSearch},colSearch:function(col){
var colSearch=my_widget_script.dataSearch("col",col)
;return colSearch},rowSearch:function(row){
var rowSearch=my_widget_script.dataSearch("row",row)
;return rowSearch},mouseSearch:function(mouse){
var mouseSearch=my_widget_script.dataSearch("mouse",mouse)
;return mouseSearch},cellSearch:function(cell){
var cellSearch=my_widget_script.dataSearch("cell",cell)
;return cellSearch},calcSearch:function(calc){
var calcSearch=this.dataSearch("calc",calc)
;return calcSearch},watchSearch:function(watch){
var watchSearch=this.dataSearch("watch",watch)
;return watchSearch},watchValue:function($el){
var watch=$el.data("watch"),calcSearch=this.calcSearch(watch),slide=$el.data("slide"),val=$el.val()
;if(slide)calcSearch+=this.slideSearch(slide)
;$(calcSearch).html(val),this.resize()},
makeSlide:function(slide){
var slideSearch=my_widget_script.slideSearch(slide),cols=$(".numCols"+slideSearch).val(),rows=$(".numRows"+slideSearch).val(),proceed=true
;if(cols&&rows){
cols=parseInt(cols),rows=parseInt(rows)
;var orientation=$(".orientation"+slideSearch).val()
}else alert("Select both number of columns and rows"),
proceed=false
;if(proceed&&my_widget_script.checkInArray(slide,my_widget_script.slideNums))proceed=confirm("Are you sure that you wish to replace the existing slide?");else my_widget_script.slideNums[my_widget_script.slideNums.length]=slide
;if(proceed)my_widget_script.buildForSlideDiv(slide,rows,cols,orientation)
},
buildForSlideDiv:function(slide,rows,cols,orientation){
var $div=$(".slideDiv"+my_widget_script.slideSearch(slide))
;$div.find(".forSlide").remove(),
$div.append($("<div/>",{
class:"forSlide container mt-2",
"data-numcols":cols,"data-numrows":rows,
"data-orientation":orientation,"data-slide":slide
}));for(var mouseNum=1,i=0;i<rows;i++){var row=i+1
;if("col"==orientation)var mouseNum=row
;$div.find(".forSlide").append($("<div/>",{
class:"row","data-row":row}))
;for(var rowSearch=my_widget_script.rowSearch(row),$rowRow=$div.find(".row"+rowSearch),j=0;j<cols;j++){
var col=j+1;if($rowRow.append($("<div/>",{
class:"col slideCell","data-col":col,
"data-cell":mouseNum}).on("dblclick",function(){
var text=$(this).text()
;$(this).addClass("fixing").addClass("filled"),$(".forFixing").show(),
$("#fixVal").val(text).select(),
my_widget_script.resize()
}).append(mouseNum)),"col"==orientation)mouseNum+=rows;else mouseNum++
}}my_widget_script.resize()},
checkInArray:function(searchVal,array){
var proceed=-1!==$.inArray(searchVal,array)
;return proceed},makeSlideDiv:function(lastSlide){
for(var $div=$(".allSlides"),myLeftCol="col-12 col-sm-6 col-md-4 col-lg-3 text-left text-sm-right",i=0;i<lastSlide;i++){
var slide=i+1
;if(!this.checkInArray(slide,this.slideDivNums)){
this.slideDivNums[this.slideDivNums.length]=slide
;var lastSlideSearch=this.slideSearch(slide-1),lastRowNum=$(".numRows"+lastSlideSearch).val(),lastColNum=$(".numCols"+lastSlideSearch).val(),lastOrientation=$(".orientation"+lastSlideSearch).val()
;if(lastRowNum)lastRowNum=parseInt(lastRowNum);else lastRowNum=2
;if(lastColNum)lastColNum=parseInt(lastColNum);else lastColNum=4
;if(!lastOrientation)lastOrientation="col"
;$("#selectSlide").append($("<option/>",{
value:slide,selected:true
}).append("Slide <span data-calc='slideNum' data-slide='"+slide+"'>"+slide+"</span>")),
$(".selectDiv").after($("<div/>",{
class:"container slideDiv mt-2","data-slide":slide
}).append($("<div/>",{class:"row"
}).append("<h3 class='col'>Slide <span data-calc='slideNum' data-slide='"+slide+"'>"+slide+"</span></h3>")).append($("<div></div>",{
class:"row mt-2"}).append($("<div/>",{
class:myLeftCol
}).append("Slide #:")).append($("<div/>",{
class:"col"}).append($("<input/>",{type:"number",
name:"slidenum"+slide,id:"slideNum"+slide,
class:"slideNum watch fullWidth",
"data-slide":slide,"data-watch":"slideNum",
value:slide}).on("change",e=>{
this.watchValue($(e.currentTarget))
})))).append($("<div/>",{class:"row mt-2"
}).append($("<div/>",{class:myLeftCol
}).append("Date of slide:")).append($("<div/>",{
class:"col"}).append($("<input/>",{type:"date",
name:"slidedate"+slide,id:"slideDate"+slide,
class:"slideDate fullWidth","data-slide":slide,
placeholder:"YYYY-MM-DD"}).each((i,e)=>{
this.checkDateFormat($(e))
}).on("change",function(){
this.checkDateFormat($(e))
})))).append($("<div/>",{class:"row mt-2"
}).append($("<div/>",{class:myLeftCol
}).append("Sample Information:")).append($("<div/>",{
class:"col"
}).append($("<text"+"area></tex"+"tarea>",{
name:"sampleinfo"+slide,id:"sampleInfo"+slide,
class:"sampleInfo fullWidth autoAdjust",
"data-slide":slide}).on("input",e=>{
e.currentTarget.style.height="auto",e.currentTarget.style.height=e.currentTarget.scrollHeight+"px",
this.resize()})))).append($("<div/>",{
class:"row mt-2 hideView"}).append($("<div/>",{
class:myLeftCol
}).append("Number of Rows:")).append($("<div/>",{
class:"col"}).append($("<input/>",{type:"number",
name:"numrows"+slide,id:"numRows"+slide,
class:"numRows fullWidth","data-slide":slide,
step:1,value:lastRowNum})))).append($("<div/>",{
class:"row mt-2 hideView"}).append($("<div/>",{
class:myLeftCol
}).append("Number of Columns:")).append($("<div/>",{
class:"col"}).append($("<input/>",{type:"number",
name:"numcols"+slide,id:"numColss"+slide,
class:"numCols fullWidth","data-slide":slide,
step:1,value:lastColNum})))).append($("<div/>",{
class:"row mt-2 hideView"}).append($("<div/>",{
class:myLeftCol
}).append("Select Orientation:")).append($("<div/>",{
class:"col"}).append($("<select/>",{
name:"orientation"+slide,id:"orientation"+slide,
class:"orientation fullWidth","data-slide":slide
}).append($("<option/>",{value:"col"
}).append("By column")).append($("<option/>",{
value:"row"
}).append("By row"))))).append($("<div/>",{
class:"row mt-2 hideView"}).append($("<div/>",{
class:myLeftCol
}).append("Create slide:")).append($("<div/>",{
class:"col"}).append($("<input/>",{type:"button",
name:"makeslide"+slide,id:"makeSlide"+slide,
class:"makeSlide fullWidth","data-slide":slide,
value:"Make slide"}).on("click",function(){
var slideNum=$(this).data("slide")
;my_widget_script.makeSlide(slideNum)
})))).append($("<div/>",{class:"row mt-2 hideView"
}).append($("<div/>",{class:"col"
}).append("Double click on cell to edit value")))),
$div.find(".orientation"+my_widget_script.slideSearch(slide)).val(lastOrientation)
;var slideSearch=my_widget_script.slideSearch(slide)
;$(".slideDiv"+slideSearch).show(),
$(".slideDiv").not(slideSearch).hide(),my_widget_script.resize()
}}}};