my_widget_script={numWashes1:0,numWashes2:0,
init:function(mode,json_data){
var parsedJson=this.parseInitJson(json_data)
;this.initDynamicContent(parsedJson),
window.onresize=(()=>this.resize()),this.addEventListeners(),
this.parent_class.init(mode,()=>JSON.stringify(parsedJson.widgetData))
;var numWashes1=3
;if(parsedJson.numWashes1)numWashes1=parsedJson.numWashes1
;$("#numWashes1").val(numWashes1);var numWashes2=3
;if(parsedJson.numWashes2)numWashes2=parsedJson.numWashes2
;$("#numWashes2").val(numWashes2),
this.addRequiredFieldIndicators(),this.setUpInitialState(),
this.adjustForMode(mode),this.checkForNames()},
to_json:function(){
var widgetJsonString=this.parent_class.to_json(),dynamicContent=this.getDynamicContent(),output={
widgetData:JSON.parse(widgetJsonString),
abNums:this.abNums,numWashes1:this.numWashes1,
numWashes2:this.numWashes2}
;return JSON.stringify(output)},
from_json:function(json_data){
var parsedJson=JSON.parse(json_data)
;this.parent_class.from_json(JSON.stringify(parsedJson.widgetData))
},test_data:function(){
var testData=JSON.parse(this.parent_class.test_data()),output={
widgetData:testData};return JSON.stringify(output)
},is_valid:function(b_suppress_message){
var fail=false,fail_log="",name
;if($("#the_form").find("select, textarea, input").each((i,e)=>{
if(!$(e).prop("required"));else if(!$(e).val())fail=true,
name=$(e).attr("id"),fail_log+=name+" is required \n"
}),$("input[type='date']").each((i,e)=>{
var date=$(e).val();if(date){
var validDate=this.isValidDate(date)
;if(!validDate)fail=true,fail_log+="Please enter valid date in form 'YYYY-MM-DD'"
}}),$("input[type='time']").each((i,e)=>{
var time=$(e).val();if(time){
var validtime=this.isValidTime(time)
;if(!validtime)fail=true,fail_log+="Please enter valid time in form 'hh:mm' - 24 hr time"
}}),fail)return bootbox.alert(fail_log);else{
var noErrors=[];return noErrors}},
is_edited:function(){
return this.parent_class.is_edited()},
reset_edited:function(){
return this.parent_class.reset_edited()},
parseInitJson:function(json_data){var jsonString
;if("string"===typeof json_data)jsonString=json_data;else jsonString=json_data()
;var parsedJson=JSON.parse(jsonString)
;return parsedJson},
initDynamicContent:function(parsedJson){
if(parsedJson.abNums)for(var i=0;i<parsedJson.abNums.length;i++){
var abNum=parsedJson.abNums[i]
;this.addAntibodies(abNum)}var numWashes1=3
;if(parsedJson.numWashes1)numWashes1=parsedJson.numWashes1
;this.updateWashTracking(numWashes1,1)
;var numWashes2=3
;if(parsedJson.numWashes2)numWashes2=parsedJson.numWashes2
;this.updateWashTracking(numWashes2,2)},
adjustForMode:function(mode){
if("edit"!==mode&&"edit_dev"!==mode)$(".disableOnView").prop("disabled",true),
$("input[type='date']").removeClass(".hasDatePicker"),
$(".hideView").hide();else $("input[type='date']").each((i,e)=>{
this.checkDateFormat($(e))
}),$("input[type='time']").each((i,e)=>{
this.checkTimeFormat($(e))})},
addEventListeners:function(){},
addRequiredFieldIndicators:function(){
$(".needForTableLab").each((i,e)=>{
$(e).html("<span class='hideView' style='color:blue'>#</span>"+$(e).html())
}),$(".requiredLab").each((i,e)=>{
$(e).html("<span class='hideView' style='color:red'>*</span>"+$(e).html())
})},isValidTime:function(timeString){
var regEx="^(((([0-1][0-9])|(2[0-3])):[0-5][0-9]))$"
;if(!timeString.match(regEx))return false;else return true
},isTimeSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","time")
;var supported=true
;if("time"!==input.type)supported=false
;return this.timeSupported=supported,input.remove(),
supported},timeSupported:true,
checkTimeFormat:function($timeInput){
if(!this.timeSupported){
$timeInput.next(".timeWarning").remove()
;var time=$timeInput.val(),isValid=this.isValidTime(time)
;if(!isValid)$timeInput.after('<div class="text-danger timeWarning">Enter time as "hh:mm" in 24-hr format</div>')
;this.resize()}},isValidDate:function(dateString){
var regEx=/^\d{4}-\d{2}-\d{2}$/
;if(!dateString.match(regEx))return false
;var d=new Date(dateString),dNum=d.getTime()
;if(!dNum&&0!==dNum)return false
;return d.toISOString().slice(0,10)===dateString},
isDateSupported:function(){
var input=document.createElement("input")
;input.setAttribute("type","date")
;var supported=true
;if("date"!==input.type)supported=false
;return this.dateSupported=supported,input.remove(),
supported},dateSupported:true,
checkDateFormat:function($dateInput){
if(!this.dateSupported){
$dateInput.next(".dateWarning").remove()
;var date=$dateInput.val(),isValid=this.isValidDate(date)
;if(!isValid)$dateInput.after('<div class="text-danger dateWarning">Enter date as "YYYY-MM-DD"</div>')
;$dateInput.datepicker({dateFormat:"yy-mm-dd"
}),this.resize()}},setUpInitialState:function(){
this.isDateSupported(),this.isTimeSupported(),
$("input[type='date']").prop("placeholder","YYYY-MM-DD").on("change",e=>{
this.checkDateFormat($(e.currentTarget))
}),$("input[type='time']").prop("placeholder","hh:mm").on("change",e=>{
this.checkTimeFormat($(e.target))
}),$(".myLeftCol4").addClass("col-6 col-md-4 col-lg-3 text-right"),
$(".myLeftCol").addClass("col-4 col-sm-5 col-md-4 col-lg-5 text-right"),
$(".myLeftCol2").addClass("col-6 col-sm-5 col-md-4 col-lg-5 text-right"),
$(".myLeftCol3").addClass("col-2 col-lg-1 text-right"),
$("textarea.autoAdjust").each((i,e)=>{
e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")
}).on("input",e=>{
e.target.style.height="auto",e.target.style.height=e.target.scrollHeight+"px",
this.resize()}),$(".watchTime").each((i,e)=>{
var $elToWatch=$(e),$elToFill=$(e).parent().next().find($(".fillTime"))
;this.watchTime($elToWatch,$elToFill)
}).on("input",e=>{
var $elToWatch=$(e.currentTarget),$elToFill=$(e.currentTarget).parent().next().find($(".fillTime"))
;my_widget_script.watchTime($elToWatch,$elToFill)
}),$(".card-header").on("click",e=>{
this.toggleCard($(e.currentTarget))
}),$("#desiredPBSVol").on("change",e=>{
var desiredFinalVol=$(e.currentTarget).val(),startVol=this.PBS10xTo1xCalc(desiredFinalVol)
;$("#vol10xPBS").text(startVol)}).each((i,e)=>{
var desiredFinalVol=$(e).val(),startVol=this.PBS10xTo1xCalc(desiredFinalVol)
;$("#vol10xPBS").text(startVol)
}),$(".updatePBST1").on("change",e=>{
var solns=this.PBST1Calc()
}),$(".updatePBST2").on("change",e=>{
var solns=this.PBST2Calc()
}),$("#addAntibody").on("click",()=>{
this.addAntibodyClick()
}),$("#addCRHcFosABs").on("click",()=>{
this.addCRHcFosABsClick()
}),$("#desiredSecondaryVol").on("input",()=>{
this.secondaryAbSolnCalc()
}),$(".calcVol").on("change",e=>{
this.calcVolByPlate($(e.currentTarget))
}).each((i,e)=>{this.calcVolByPlate($(e))
}),$(".watch").each((i,e)=>{this.watchValue($(e))
}).on("input",e=>{
this.watchValue($(e.currentTarget))
}),$(".numWashes").on("change",e=>{
var whichWash=$(e.currentTarget).data("whichwash")
;this.updateWashTracking($(e.currentTarget).val(),whichWash)
}),$(".washDur").on("change",e=>{
var washDur=$(e.currentTarget).val(),timeText=this.getTimeText(washDur),whichWash=$(e.currentTarget).data("whichwash")
;$(".updateWashDur"+whichWash).attr("data-time",timeText),
$(".updateWashDur"+whichWash).data("time",timeText),
$(".watchTime").each((i,e)=>{
var $elToWatch=$(e),$elToFill=$(e).parent().next().find($(".fillTime"))
;this.watchTime($elToWatch,$elToFill)})
}),$("#secondaryDur").on("change",e=>{
var secondaryDur=$(e.currentTarget).val(),timeText=this.getTimeText(secondaryDur)
;$(".updateSecondaryDur").attr("data-time",timeText),
$(".updateSecondaryDur").data("time",timeText),
$(".watchTime").each((i,e)=>{
var $elToWatch=$(e),$elToFill=$(e).parent().next().find($(".fillTime"))
;this.watchTime($elToWatch,$elToFill)})
}),this.PBST1Calc(),this.PBST2Calc(),this.secondaryAbSolnCalc(),
this.resize()},resize:function(){
this.parent_class.resize_container()},
checkForNames:function(){
$("input, select, textarea").each((i,e)=>{
var hasName=$(e).attr("name")
;if(!hasName)console.log("There is no name attribute for: ",e.id)
})},getDynamicContent:function(){
var dynamicContent={};return dynamicContent},
data_valid_form:function(){var valid=true
;if($(".needForTable").each((i,e)=>{
if(!$(e).val())valid=false
}),!valid)$("#errorMsg").html("<span style='color:red; font-size:36px;'>Please fill out all elements marked by a</span><span style='color:blue; font-size:36px;'> blue #</span>");else $("#errorMsg").html("")
;return valid},
runIfConfirmed:function(text,functionToCall){
var thisMessage="Are you sure?"
;if(text)thisMessage=text;bootbox.confirm({
message:thisMessage,callback:proceed=>{
if(proceed)functionToCall()}})},
dialogConfirm:function(text,functionToCall){
var thisMessage="Do you want to proceed?"
;if(text)thisMessage=text;bootbox.confirm({
message:thisMessage,callback:result=>{
functionToCall(result)}})},
runBasedOnInput:function(prompt,functionToCall){
var thisTitle="Enter value:"
;if(prompt)thisTitle=prompt;bootbox.prompt({
title:thisTitle,callback:result=>{
functionToCall(result)}})},
toggleCard:function($cardHead){
$cardHead.next().toggleClass("collapse"),$cardHead.next().find("textarea.autoAdjust").each((i,e)=>{
if(!$(e).is(":hidden"))e.setAttribute("style","height:"+e.scrollHeight+"px;overflow-y:hidden;")
}),my_widget_script.resize()},abNums:[],
checkInArray:function(searchVal,array){
var inArray=-1!==$.inArray(searchVal,array)
;return inArray},
dataSearch:function(dataName,dataValue){
var dataSearch="[data-"+dataName+"='"+dataValue+"']"
;return dataSearch},abNumSearch:function(abNum){
var abSearch=this.dataSearch("abnum",abNum)
;return abSearch},calcSearch:function(calc){
var calcSearch=this.dataSearch("calc",calc)
;return calcSearch},watchSearch:function(watch){
var watchSearch=this.dataSearch("watch",watch)
;return watchSearch},watchValue:function($el){
var watch=$el.data("watch"),calcSearch=this.calcSearch(watch),abNum=$el.data("abnum"),val=$el.val()
;if(abNum)calcSearch+=this.abNumSearch(abNum)
;$(calcSearch).html(val),this.resize()},
getHoursMin:function(timeString){
timeString=timeString.split(":")
;var hours=parseInt(timeString[0],10),mins=parseInt(timeString[1],10)
;return split={hours:hours,mins:mins}},
watchTime:function($elToWatch,$elToFill){
var addTime=$elToFill.data("time"),startTime=$elToWatch.val()
;if(startTime){var time=new Date
;startTimeSplit=my_widget_script.getHoursMin(startTime),
addTimeSplit=my_widget_script.getHoursMin(addTime),
time.setHours(startTimeSplit.hours,startTimeSplit.mins,0,0),
time.setHours(time.getHours()+addTimeSplit.hours),
time.setMinutes(time.getMinutes()+addTimeSplit.mins),
$elToFill.text(time.toLocaleTimeString())
}else $elToFill.text("{Enter Start Time}")
;my_widget_script.resize()},
startVolOfDilutionCalc:function(dilFraction,desiredFinalVol){
var startVol=desiredFinalVol*dilFraction
;return startVol},
PBS10xTo1xCalc:function(desiredFinalVol){
if(desiredFinalVol>0)var dilFraction=1/10,startVol=+this.startVolOfDilutionCalc(dilFraction,desiredFinalVol).toFixed(2);else var startVol="[Enter desired amount]"
;return startVol},calcVolByPlate:function($el){
var plateSize=$el.val(),type=$el.data("volwatch"),typeSearch=this.dataSearch("volcalc",type),amnt
;if(24==plateSize)amnt="500&micro;";else if(12==plateSize)amnt="1.5m";else if(6==plateSize)amnt="3m";else amnt="specify appropriate plate size"
;$(".printVol"+typeSearch).html(amnt)},
PBST1Calc:function(version){
var desiredFinalVol=$("#desiredPBST2Vol").val(),percTriton=$("#percTriton2").val()
;if(!(percTriton>0)||percTriton>100)percTriton=.1,
$("#percTriton2").val(.1),this.watchValue($("#percTriton2"))
;var dilFractionTriton=percTriton/100
;if(desiredFinalVol>0)var startVolTritonx100=this.startVolOfDilutionCalc(dilFractionTriton,desiredFinalVol),startVolTriton20percmL=5*startVolTritonx100,startVolTriton20percuL=+(1e3*startVolTriton20percmL).toFixed(2),startVolPBS=+(desiredFinalVol-startVolTriton20percmL).toFixed(2);else var startVolTriton20percuL="[Enter desired amount]",startVolPBS="[Enter desired amount]"
;return solns={triton2:startVolTriton20percuL,
PBS2:startVolPBS
},$("#volTriton2").text(solns.triton2),$("#volPBS2").text(solns.PBS2),
$(".PBST1_option").text(percTriton+"% PBS-T"),
solns},PBST2Calc:function(version){
var desiredFinalVol=$("#desiredPBST3Vol").val(),percTriton=$("#percTriton3").val()
;if(!(percTriton>0)||percTriton>100)percTriton=.4,
$("#percTriton3").val(.4),this.watchValue($("#percTriton3"))
;var dilFractionTriton=percTriton/100
;if(desiredFinalVol>0)var startVolTritonx100=this.startVolOfDilutionCalc(dilFractionTriton,desiredFinalVol),startVolTriton20percmL=5*startVolTritonx100,startVolTriton20percuL=+(1e3*startVolTriton20percmL).toFixed(2),startVolPBS=+(desiredFinalVol-startVolTriton20percmL).toFixed(2);else var startVolTriton20percuL="[Enter desired amount]",startVolPBS="[Enter desired amount]"
;return solns={triton3:startVolTriton20percuL,
PBS3:startVolPBS
},$("#volTriton3").text(solns.triton3),$("#volPBS3").text(solns.PBS3),
$(".PBST2_option").text(percTriton+"% PBS-T"),
solns},secondaryAbSolnCalc:function(){
var $secondaryVol=$("#desiredSecondaryVol"),secondaryVol=$secondaryVol.val()
;if(secondaryVol>0)$(".abDilution").each((i,e)=>{
var abNum=$(e).data("abnum"),abSearch=this.abNumSearch(abNum),dilutionFactor=$(e).val()
;if(dilutionFactor>0){
var dilutionVal=1/dilutionFactor,amountAb_mL=this.startVolOfDilutionCalc(dilutionVal,secondaryVol),amountAb_uL=+(1e3*amountAb_mL).toFixed(2),stockDilution=$(".abStock"+abSearch).val()
;if(stockDilution>0)var amountAbStock_uL=+(amountAb_uL*stockDilution).toFixed(2);else var amountAbStock_uL="[Enter stock dilution]"
}else var amountAb_uL="[Enter dilution factor]",amountAbStock_uL="[Enter dilution factor]"
;$(".abAmount"+abSearch).text(amountAbStock_uL)
});else secondaryVol="[Enter desired volume]",
$(".abDilution").each((i,e)=>{
var abNum=$(e).data("abnum"),abSearch=this.abNumSearch(abNum)
;$(".abAmount"+abSearch).text("[Enter desired volume]")
})
;$("#volBlockingForSecondary").text(secondaryVol)
},addAntibodyClick:function(){var abNum=1
;if(this.abNums.length>0){
var lastAb=this.abNums[this.abNums.length-1]
;abNum=lastAb+1}
var inArray=this.checkInArray(abNum,this.abNums)
;if(!inArray)this.addAntibodies(abNum)},
addCRHcFosABsClick:function(){var abNum=1
;if(this.abNums.length>0){
var lastAb=this.abNums[this.abNums.length-1]
;abNum=lastAb+1}
var inArray=this.checkInArray(abNum,this.abNums)
;if(!inArray)this.addAntibodies(abNum)
;var abSearch=this.abNumSearch(abNum)
;$(".abName"+abSearch).val("goat anti-rabbit")
;var calcSearch=this.calcSearch("abName")
;$(calcSearch+abSearch).text("goat anti-rabbit"),
$(".abDilution"+abSearch).val("500"),abNum++
;var inArray=this.checkInArray(abNum,this.abNums)
;if(!inArray)this.addAntibodies(abNum)
;var abSearch=this.abNumSearch(abNum)
;$(".abName"+abSearch).val("goat anti-chicken")
;var calcSearch=this.calcSearch("abName")
;$(calcSearch+abSearch).text("goat anti-chicken"),
$(".abDilution"+abSearch).val("500"),
this.secondaryAbSolnCalc()},
addAntibodies:function(abNum){
this.abNums.push(abNum)
;var myLeftCol="col-4 col-sm-5 col-md-4 col-lg-5 text-right"
;$("#abInfo").append($("<div></div>",{
class:"row mt-2","data-abnum":abNum
}).append($("<h4></h4>",{class:"col",
"data-abnum":abNum,"data-calc":"abName"
}).append("Antibody "+abNum)).append($("<div></div>",{
class:"col"}).append($("<input></input>",{
type:"button","data-abnum":abNum,
value:"Delete antibody",name:"deleteab"+abNum,
id:"deleteAb"+abNum,
class:"col fullWidth deleteAb hideView"
}).on("click",e=>{this.deleteAb(abNum)
})))).append($("<div></div>",{class:"row",
"data-abnum":abNum
}).append("<div class='"+myLeftCol+"'>Antibody name</div>").append($("<div></div>",{
class:"col"}).append($("<input></input>",{
class:"fullWidth abName watch",type:"text",
name:"abname"+abNum,id:"abName"+abNum,
"data-abnum":abNum,"data-watch":"abName",
value:"Ab "+abNum})))).append($("<div></div>",{
class:"row","data-abnum":abNum
}).append("<div class='"+myLeftCol+"'>Final ab dilution (1:x)</div>").append($("<div></div>",{
class:"col"}).append($("<input></input>",{
class:"fullWidth abDilution",type:"number",
name:"abdilution"+abNum,id:"abDilution"+abNum,
"data-abnum":abNum})).on("input",e=>{
this.secondaryAbSolnCalc()
}))).append($("<div></div>",{class:"row",
"data-abnum":abNum
}).append("<div class='"+myLeftCol+"'>Current ab stock dilution(1:x)</div>").append($("<div></div>",{
class:"col"}).append($("<input></input>",{
class:"fullWidth abStock",type:"number",
name:"abstock"+abNum,id:"abStock"+abNum,value:1,
"data-abnum":abNum})).on("input",e=>{
this.secondaryAbSolnCalc()
}))),$("#abAmountInfo").append($("<div></div>",{
class:"row","data-abnum":abNum
}).append($("<div></div>",{
class:"green "+myLeftCol
}).append($("<span></span>",{class:"abAmount",
"data-abnum":abNum
})).append(" &micro;L")).append($("<div></div>",{
class:"col","data-abnum":abNum,
"data-calc":"abName"
}))),$("#abInfo").find(".watch").each((i,e)=>{
this.watchValue($(e))}).on("input",e=>{
this.watchValue($(e.target))})},
deleteAb:function(abNum){
this.runIfConfirmed("Are you sure that you wish to delete this antibody?",()=>{
var search=this.abNumSearch(abNum)
;$(search).remove()
;var index=this.abNums.indexOf(abNum)
;if(index>-1)this.abNums.splice(index,1)})},
updateWashTracking:function(numWashes,whichWash){
var currentNumWashes
;if(currentNumWashes=parseInt(this["numWashes"+whichWash]),currentNumWashes<numWashes){
for(i=currentNumWashes;i<numWashes;i++)this.makeWashRow(i,whichWash)
;this["numWashes"+whichWash]=numWashes
}else if(currentNumWashes>numWashes)this.dialogConfirm("Are you sure you want to remove a wash?",result=>{
if(result){
for(i=currentNumWashes;i>=numWashes;i--){
var washSearch=this.dataSearch("wash",i)+this.dataSearch("whichwash",whichWash)
;$(washSearch).remove()}
this["numWashes"+whichWash]=numWashes
}else $("#numWashes"+whichWash).val(currentNumWashes)
;this.resize()});this.resize()},
getTimeText:function(timeInMin){var hours=0,min=0
;if(timeText="00:00",timeInMin)hours=Math.floor(timeInMin/60),
min=Math.round(timeInMin%60),
timeText=("00"+hours).slice(-2)+":"+("00"+min).slice(-2)
;return timeText},
makeWashRow:function(washIndex,whichWash){
var myLeftCol4="col-6 col-md-4 col-lg-3 text-right",timeText=this.getTimeText($("#washDur").val()),printNum=washIndex+1
;$("#washTimeDiv"+whichWash).append($("<div></div>",{
class:"row mt-1","data-wash":washIndex,
"data-whichwash":whichWash
}).append($("<div></div>",{class:myLeftCol4
}).append($("<input></input>",{type:"time",
name:"rinsetime"+washIndex+"w"+whichWash,
id:"rinseTime"+washIndex+"w"+whichWash,
class:"watchTime fullWidth"}).on("input",e=>{
var $elToWatch=$(e.currentTarget),$elToFill=$(e.currentTarget).parent().next().find($(".fillTime"))
;this.watchTime($elToWatch,$elToFill)
}))).append($("<div></div>",{class:"col"
}).append("Wash "+printNum+" complete at <span class='fillTime purple updateWashDur"+whichWash+"' data-time='"+timeText+"'>{Enter Start Time}</span>")))
}};